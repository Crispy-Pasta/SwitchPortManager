
<!DOCTYPE html>
<html>
<head>
    <title>Switch Inventory - Dell Port Tracer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=5.2">
    <link rel="stylesheet" href="{{ url_for('static', filename='navigation.css') }}?v=1.0">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .inventory-page {
            background: var(--deep-navy);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 0;
        }
        
        /* Header and navigation styles moved to global navigation.css file */
        
        .main-content {
            padding: 30px;
            max-width: 1800px;
            margin: 0 auto;
        }
        
        .inventory-layout {
            display: flex;
            align-items: flex-start;
            min-height: 400px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            max-width: 1750px;
            margin: 0 auto;
        }
        
        .sidebar {
            width: 500px;
            background: white;
            border-right: 1px solid #e5e7eb;
            flex-shrink: 0;
            border-radius: 0;
            box-shadow: none;
            display: flex;
            flex-direction: column;
            min-height: 700px;
            max-height: calc(100vh - 150px);
        }
        
        .content-area {
            flex: 1;
            background: white;
            overflow-y: auto;
            padding: 20px;
            border-radius: 0;
            box-shadow: none;
            min-height: calc(100vh - 280px);
        }
        
        /* Duplicate navigation styles removed - using global navigation.css */
        
        /* Sidebar Structure Styles */
        .sidebar-header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            flex-shrink: 0;
        }
        
        .site-tree-scrollable {
            flex: 1;
            overflow-y: auto;
            background: white;
        }
        
        /* Site Tree Styles */
        .site-tree {
            padding: 20px;
        }
        
        .tree-header .search-box {
            margin-top: 12px;
        }
        
        .tree-header .search-input {
            width: 100%;
            max-width: 280px;
            font-size: 13px;
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .tree-header {
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--orange);
        }
        
        .tree-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--deep-navy);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tree-item {
            margin-bottom: 8px;
        }
        
        .tree-site {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .site-header {
            padding: 12px 16px;
            background: linear-gradient(135deg, var(--deep-navy), #1e3a8a);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .site-header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        
        .site-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .site-right {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
            min-width: 0;
        }
        
        .site-stats {
            font-size: 11px;
            opacity: 0.9;
            margin-right: 6px;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .site-header:hover {
            background: linear-gradient(135deg, #1e3a8a, var(--orange));
        }
        
        .site-actions {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
            white-space: nowrap;
        }
        
        .site-actions .action-btn {
            white-space: nowrap;
            font-size: 9px;
            padding: 2px 6px;
            border: none;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            transition: background-color 0.2s ease;
            min-width: auto;
        }
        
        .site-actions .action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Contextual Floor Actions */
        .floor-actions {
            padding: 8px 16px;
            background: #f1f5f9;
            border-bottom: 1px solid #e2e8f0;
            display: none;
        }
        
        .floor-actions.show {
            display: block;
        }
        
        .floor-actions-buttons {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        
        .floor-action-btn {
            padding: 4px 8px;
            border: 1px solid #64748b;
            background: white;
            color: #64748b;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .floor-action-btn:hover {
            background: var(--orange);
            color: white;
            border-color: var(--orange);
            transform: translateY(-1px);
        }
        
        .floor-actions-label {
            font-size: 10px;
            color: #64748b;
            margin-right: 8px;
            font-weight: 600;
        }
        
        .site-stats {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .expand-icon {
            font-size: 14px;
            transition: transform 0.2s ease;
        }
        
        .site-header.expanded .expand-icon {
            transform: rotate(90deg);
        }
        
        .floors-container {
            display: none;
            background: white;
        }
        
        .floors-container.expanded {
            display: block;
        }
        
        .floor-item {
            border-bottom: 1px solid #f0f0f0;
            padding: 10px 20px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .floor-item:last-child {
            border-bottom: none;
        }
        
        .floor-item:hover {
            background: #f8fafc;
        }
        
        .floor-item.selected {
            background: rgba(255, 114, 0, 0.1);
            border-left: 4px solid var(--orange);
            font-weight: 600;
            color: var(--deep-navy);
        }
        
        .floor-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .floor-switch-count {
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }
        
        .floor-switch-count .action-btn {
            white-space: nowrap;
            font-size: 9px;
            padding: 1px 4px;
            border: 1px solid #64748b;
            background: white;
            color: #64748b;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: auto;
            display: inline-flex;
            align-items: center;
            gap: 2px;
        }
        
        .floor-switch-count .action-btn:hover {
            background: var(--orange);
            color: white;
            border-color: var(--orange);
        }
        
        .floor-item.selected .floor-switch-count {
            background: var(--orange);
            color: white;
        }
        
        /* Content Area Styles */
        .content-header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            color: #6b7280;
        }
        
        .breadcrumb-separator {
            color: #d1d5db;
        }
        
        .breadcrumb .current {
            color: var(--orange);
            font-weight: 600;
        }
        
        .floor-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--deep-navy);
            margin: 0 0 8px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .floor-description {
            color: #6b7280;
            margin: 0;
        }
        
        /* Statistics Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            transition: transform 0.2s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .stat-number.total {
            color: var(--orange);
        }
        
        .stat-number.active {
            color: #10b981;
        }
        
        .stat-number.inactive {
            color: #ef4444;
        }
        
        .stat-number.models {
            color: #6366f1;
        }
        
        .stat-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        
        /* Switch Table */
        .switches-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }
        
        .switches-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .switches-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--deep-navy);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .switches-controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            padding: 16px 0;
        }
        
        /* Standardized Add Switch Button */
        .add-switch-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            background: linear-gradient(135deg, var(--orange), #e68900);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255, 114, 0, 0.2);
            white-space: nowrap;
            height: 40px;
            min-width: 120px;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .add-switch-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.3), 
                transparent);
            transition: left 0.5s ease;
        }
        
        .add-switch-btn:hover::before {
            left: 100%;
        }
        
        .add-switch-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(255, 114, 0, 0.4);
            filter: brightness(1.1);
        }
        
        .add-switch-btn .btn-icon {
            font-size: 16px;
            font-weight: 700;
        }
        
        /* Standardized Search Box */
        .search-box {
            position: relative;
            flex: 1;
            max-width: 300px;
            min-width: 200px;
        }
        
        .search-input {
            width: 100%;
            padding: 10px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background-color: white;
            transition: all 0.3s ease;
            box-sizing: border-box;
            height: 40px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--orange);
            box-shadow: 0 0 0 3px rgba(255, 114, 0, 0.1);
        }
        
        .search-input::placeholder {
            color: #9ca3af;
            font-size: 14px;
        }
        
        /* Filter Buttons Container */
        .filter-buttons {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        
        /* Standardized Filter Buttons */
        .filter-btn {
            padding: 10px 16px;
            border: 2px solid #e5e7eb;
            background: white;
            color: #374151;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            height: 40px;
            min-width: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .filter-btn:hover {
            border-color: var(--orange);
            color: var(--orange);
            background: rgba(255, 114, 0, 0.05);
            transform: translateY(-1px);
        }
        
        .filter-btn.active {
            background: var(--orange);
            color: white;
            border-color: var(--orange);
            box-shadow: 0 2px 8px rgba(255, 114, 0, 0.2);
        }
        
        .filter-btn.active:hover {
            background: #e68900;
            border-color: #e68900;
        }
        
        /* Sidebar Search Styling */
        .tree-header .search-box {
            margin-top: 12px;
            max-width: none;
            min-width: auto;
        }
        
        .tree-header .search-input {
            font-size: 13px;
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.9);
            height: 36px;
        }
        
        /* Management Buttons in Sidebar */
        .management-buttons {
            display: flex;
            gap: 8px;
            margin: 12px 0;
            flex-wrap: wrap;
        }
        
        .management-buttons .action-btn {
            padding: 8px 12px;
            border: 1px solid var(--orange);
            background: var(--orange);
            color: white;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            height: 32px;
            display: flex;
            align-items: center;
        }
        
        .management-buttons .action-btn:hover {
            background: linear-gradient(135deg, var(--deep-navy), #1e3a8a);
            color: white !important;
            border-color: var(--deep-navy);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
            filter: brightness(1.1);
        }
        
        .switches-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .switches-table th {
            background: #f8fafc;
            color: #374151;
            font-weight: 600;
            padding: 12px 16px;
            text-align: left;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .switches-table td {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
        }
        
        .switches-table tr:last-child td {
            border-bottom: none;
        }
        
        .switches-table tr:hover {
            background: #f8fafc;
        }
        
        .switch-name {
            font-weight: 600;
            color: var(--deep-navy);
            margin-bottom: 4px;
        }
        
        .switch-model {
            font-size: 12px;
            color: #6b7280;
        }
        
        .switch-ip {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #374151;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-active {
            background: #dcfce7;
            color: #166534;
        }
        
        .status-inactive {
            background: #fecaca;
            color: #991b1b;
        }
        
        .switch-actions {
            display: flex;
            gap: 6px;
        }
        
        .action-btn {
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background: white;
            color: #374151;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            border-color: var(--orange);
            color: var(--orange);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .empty-description {
            font-size: 14px;
            margin: 0;
        }
        
        /* Loading State */
        .loading-state {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid var(--orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(2px);
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            max-width: 450px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            color: var(--deep-navy);
            font-size: 18px;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            background: #f3f4f6;
            color: #374151;
        }
        
        .modal-body {
            padding: 16px 20px;
        }
        
        .modal-body .form-group {
            margin-bottom: 12px;
        }
        
        .modal-body .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            color: var(--deep-navy);
            font-size: 13px;
        }
        
        .modal-body .form-group input,
        .modal-body .form-group select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: white;
            box-sizing: border-box;
        }
        
        .modal-body .form-group input:focus,
        .modal-body .form-group select:focus {
            outline: none;
            border-color: var(--orange);
            box-shadow: 0 0 0 3px rgba(255, 114, 0, 0.1);
        }
        
        .modal-body .form-group input[readonly] {
            background: #f9fafb;
            color: #6c757d;
        }
        
        .modal-body .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
        }
        
        .modal-body .checkbox-group input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin: 0;
            accent-color: var(--orange);
        }
        
        .modal-body .checkbox-group label {
            margin: 0;
            font-size: 14px;
            cursor: pointer;
        }
        
        .modal-body .form-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid #e5e7eb;
            flex-wrap: nowrap;
            align-items: center;
        }
        
        /* Delete Confirmation Modal */
        .delete-modal .modal-content {
            max-width: 450px;
        }
        
        .delete-modal .modal-header {
            background: linear-gradient(135deg, #fee2e2, #fca5a5);
            border-bottom: 1px solid #f87171;
        }
        
        .delete-modal .modal-header h3 {
            color: #dc2626;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .delete-warning {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
        
        .delete-warning-title {
            font-weight: 600;
            color: #dc2626;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .delete-warning-text {
            color: #7f1d1d;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 8px;
        }
        
        .delete-item-name {
            font-weight: 600;
            color: #991b1b;
        }
        
        .delete-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 20px;
            flex-wrap: nowrap;
            align-items: center;
        }
        
        .btn-cancel {
            padding: 8px 16px;
            background: #f9fafb;
            color: #374151;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            display: inline-block;
        }
        
        .btn-cancel:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
        }
        
        .btn-delete {
            padding: 8px 16px;
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(220, 38, 38, 0.2);
            white-space: nowrap;
            display: inline-block;
        }
        
        .btn-delete:hover {
            background: linear-gradient(135deg, #b91c1c, #991b1b);
            box-shadow: 0 4px 8px rgba(220, 38, 38, 0.3);
            transform: translateY(-1px);
        }
            padding-top: 16px;
            border-top: 1px solid #e1e8ed;
        }
        
        .modal-body .btn-primary {
            background: var(--orange);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            display: inline-block;
            min-width: 80px;
            text-align: center;
        }
        
        .modal-body .btn-primary:hover {
            background: linear-gradient(135deg, var(--deep-navy), #1e3a8a);
            color: white !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
            filter: brightness(1.1);
        }
        
        .modal-body .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            display: inline-block;
            min-width: 80px;
            text-align: center;
        }
        
        .modal-body .btn-secondary:hover {
            background: #5a6268;
        }
        
        .modal-body .btn-danger {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            display: inline-block;
            min-width: 80px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(220, 38, 38, 0.2);
        }
        
        .modal-body .btn-danger:hover {
            background: linear-gradient(135deg, #b91c1c, #991b1b);
            box-shadow: 0 4px 8px rgba(220, 38, 38, 0.3);
            transform: translateY(-1px);
        }
        
        /* UI CONSISTENCY IMPROVEMENT (January 2025)
         * Standardized button sizing across all modal dialogs
         * 
         * PROBLEM SOLVED: Edit site/floor modals had inconsistent button sizes
         * - Update and Delete buttons were larger than Cancel button
         * - Inconsistent padding, width, and visual appearance
         * 
         * SOLUTION: Comprehensive button standardization with !important declarations
         * - All modal form action buttons now have identical dimensions
         * - Consistent 80px minimum width for professional appearance
         * - Unified padding, font size, and styling across all button types
         * - Prevents text wrapping with white-space: nowrap
         * - Applies to Update (btn-primary), Delete (btn-danger), Cancel (btn-secondary)
         */
        .modal-body .form-actions button {
            min-width: 80px !important;        /* Consistent minimum width */
            text-align: center !important;     /* Center button text */
            padding: 8px 12px !important;      /* Uniform padding */
            border-radius: 6px !important;     /* Consistent border radius */
            font-size: 12px !important;        /* Standardized font size */
            font-weight: 500 !important;       /* Consistent font weight */
            cursor: pointer !important;        /* Ensure pointer cursor */
            transition: all 0.2s ease !important; /* Smooth hover effects */
            white-space: nowrap !important;     /* Prevent text wrapping */
            display: inline-block !important;   /* Consistent display type */
        }
        
        /* Toast Styles */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            color: white;
            z-index: 1100;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-width: 400px;
            font-size: 14px;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .toast.success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .toast.error {
            background: linear-gradient(135deg, #dc3545, #e74c3c);
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-content {
                flex-direction: column;
                height: auto;
                width: calc(100vw - 20px);
                padding: 30px 10px 20px 10px;
            }
            
            .sidebar {
                width: 100%;
                min-height: 400px;
                max-height: calc(100vh - 200px);
            }
            
            .content-area {
                height: auto;
            }
        }
        
        @media (max-width: 768px) {
            .switches-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }
            
            .search-input {
                width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body class="inventory-page">
        <div class="main-content">
            <div class="header-card">
                <div class="logo-section">
                    <img src="{{ url_for('static', filename='img/kmc_logo.png') }}" alt="KMC Logo">
                    <h1 class="app-title">Switch Port Tracer</h1>
                </div>
                <div class="user-profile">
                    <div class="user-avatar">{{ username[0].upper() }}</div>
                    <div class="user-details">
                        <div class="username">{{ username }}</div>
                        <div class="user-role">{{ user_role }}</div>
                    </div>
                    <a href="/logout" class="logout-btn">Logout</a>
                </div>
            </div>
            
            <div class="navigation-card">
                <div class="nav-links">
                    <a href="/" class="nav-link">&#128269; Port Tracer</a>
                    {% if user_role in ['netadmin', 'superadmin'] %}
                    <a href="/vlan" class="nav-link">&#128295; VLAN Manager</a>
                    <a href="/inventory" class="nav-link active">&#127970; Switch Management</a>
                    {% endif %}
                </div>
            </div>

            <div class="inventory-layout">
                <!-- Sidebar with Site Tree -->
                <div class="sidebar">
                    <div class="sidebar-header">
                        <div class="site-tree">
                            <div class="tree-header">
                                <h2 class="tree-title">
                                    <span>&#127970;</span>
                                    KMC Sites
                                </h2>
                                
                                <div class="management-buttons">
                                    <button class="action-btn" onclick="showAddSiteModal()" title="Add new site">
                                        + Add Site
                                    </button>
                                    <button class="action-btn" id="add-floor-btn" onclick="showAddFloorModal()" title="Add floor to selected site" style="display: none;">
                                        + Add Floor
                                    </button>
                                </div>
                                
                                <div class="search-box">
                                    <input type="text" class="search-input" id="site-search" placeholder="Search sites and floors...">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="site-tree-scrollable">
                        <div class="site-tree">
                            <div id="site-tree-container">
                                <div class="loading-state">
                                    <div class="loading-spinner"></div>
                                    Loading sites...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Main Content Area -->
                <div class="content-area">
            <div class="content-header">
                <div class="breadcrumb">
                    <span>&#127970; Sites</span>
                    <span class="breadcrumb-separator">&rsaquo;</span>
                    <span id="current-site">Select a site</span>
                    <span class="breadcrumb-separator" id="floor-separator" style="display: none;">&rsaquo;</span>
                    <span class="current" id="current-floor" style="display: none;">Select a floor</span>
                </div>
                
                <h1 class="floor-title" id="content-title">
                        <span>&#128204;</span>
                    Switch Inventory
                </h1>
                
                <p class="floor-description" id="content-description">
                    Select a site and floor from the left sidebar to view switch inventory
                </p>
            </div>
            
            <!-- Statistics Cards -->
            <div class="stats-grid" id="stats-grid" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number total" id="total-switches">0</div>
                    <div class="stat-label">Total Switches</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number active" id="active-switches">0</div>
                    <div class="stat-label">Active Switches</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number inactive" id="inactive-switches">0</div>
                    <div class="stat-label">Inactive Switches</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number models" id="unique-models">0</div>
                    <div class="stat-label">Switch Models</div>
                </div>
            </div>
            
            <!-- Switches Section -->
            <div class="switches-section" id="switches-section">
                <div class="switches-header">
                    <h3 class="switches-title">
                        <span>&#128296;</span>
                        Switch Details
                    </h3>
                    
                        <div class="switches-controls" id="switches-controls" style="display: none;">
                            <button class="add-switch-btn" id="add-switch-btn" onclick="showAddSwitchToFloorModal()" title="Add switch to selected floor" style="display: none;">
                                <span class="btn-icon">+</span> Add Switch
                            </button>
                            <div class="search-box">
                                <input type="text" class="search-input" id="switch-search" placeholder="Search switches...">
                            </div>
                            <div class="filter-buttons">
                                <button class="filter-btn active" data-filter="all">All</button>
                                <button class="filter-btn" data-filter="active">Active</button>
                                <button class="filter-btn" data-filter="inactive">Inactive</button>
                            </div>
                        </div>
                </div>
                
                <div id="switches-content">
                    <div class="empty-state">
                                <div class="empty-icon">&#128463;</div>
                        <div class="empty-title">No Floor Selected</div>
                        <div class="empty-description">Choose a site and floor from the sidebar to view switch inventory</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let sitesData = [];
        let currentSiteData = null;
        let currentFloorData = null;
        let allSwitches = [];
        let filteredSwitches = [];
        
        // Add switch to floor from main inventory view - GLOBAL FUNCTION
        function showAddSwitchToFloorModal() {
            console.log('showAddSwitchToFloorModal called');
            console.log('currentFloorData:', currentFloorData);
            console.log('currentSiteData:', currentSiteData);
            
            // Check if we have current floor data from inventory view
            if (typeof currentFloorData !== 'undefined' && currentFloorData && currentFloorData.id) {
                console.log('Using currentFloorData for modal');
                // Use current floor data from inventory
                if (typeof openAddSwitchModalWithFloor === 'function') {
                    openAddSwitchModalWithFloor(
                        currentFloorData.id, 
                        currentFloorData.name, 
                        currentSiteData ? currentSiteData.name : 'Unknown Site'
                    );
                } else {
                    console.error('openAddSwitchModalWithFloor function not available');
                    alert('Error: Modal function not available');
                }
            } else {
                console.log('currentFloorData not available, showing generic modal');
                // Show generic add switch modal that allows selection of site and floor
                if (typeof showGenericAddSwitchModal === 'function') {
                    showGenericAddSwitchModal();
                } else {
                    alert('Please select a floor first');
                }
            }
        }
        
        // Make the function globally available
        window.showAddSwitchToFloorModal = showAddSwitchToFloorModal;
        
        // Simple sidebar setup - no aggressive height manipulation
        function initializeSidebar() {
            // Simple initialization without forced height manipulation
            console.log('Sidebar initialized with natural CSS layout');
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Hide Add Switch button initially since no floor is selected
            const addSwitchBtn = document.getElementById('add-switch-btn');
            if (addSwitchBtn) {
                addSwitchBtn.style.display = 'none';
            }
            
            // Simple sidebar initialization
            initializeSidebar();
            
            loadSites();
            setupEventListeners();
        });
        
        // Setup event listeners
        function setupEventListeners() {
            // Search functionality
            document.getElementById('switch-search').addEventListener('input', handleSearchInput);
            
            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', handleFilterClick);
            });
        }
        
        // Load sites from API
        async function loadSites() {
            try {
                const response = await fetch('/api/sites');
                const data = await response.json();
                
                if (response.ok) {
                    sitesData = data;
                    // Load all switches data first for counting
                    await loadAllSwitches();
                    renderSiteTree(data);
                } else {
                    showError('Failed to load sites: ' + data.error);
                }
            } catch (error) {
                showError('Error loading sites: ' + error.message);
            }
        }
        
        // Load all switches for site counting
        async function loadAllSwitches() {
            try {
                const response = await fetch('/api/switches');
                const data = await response.json();
                
                if (response.ok) {
                    allSwitches = data; // Store all switches globally
                } else {
                    console.error('Failed to load all switches:', data.error);
                    allSwitches = [];
                }
            } catch (error) {
                console.error('Error loading all switches:', error.message);
                allSwitches = [];
            }
        }
        
        // Render the site tree
        function renderSiteTree(sites) {
            const container = document.getElementById('site-tree-container');
            
            if (sites.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">&#127970;</div>
                        <div class="empty-title">No Sites Found</div>
                        <div class="empty-description">No sites are configured in the system</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            sites.forEach(site => {
                // Calculate total switches properly from database structure
                let totalSwitches = 0;
                if (site.floors && Array.isArray(site.floors)) {
                    // Count switches across all floors for this site
                    site.floors.forEach(floor => {
                        // Count switches from the global allSwitches array for this floor
                        if (typeof allSwitches !== 'undefined' && allSwitches.length > 0) {
                            const floorSwitches = allSwitches.filter(sw => sw.floor_id == floor.id);
                            totalSwitches += floorSwitches.length;
                        }
                    });
                }
                
                // Debug logging for switch count calculation
                console.log(`Site ${site.name}: ${totalSwitches} switches calculated from allSwitches array`);
                
                const floorCount = site.floors ? site.floors.length : 0;
                
                // Escape single quotes in site name for onclick handlers
                const escapedName = site.name.replace(/'/g, "\\'");
                html += `
                    <div class="tree-item">
                        <div class="tree-site">
                            <div class="site-header" onclick="toggleSite('${site.id}')" id="site-header-${site.id}">
                                <div class="site-header-content">
                                    <div class="site-left">
                                        <span>&#127970;</span>
                                        <span>${site.name}</span>
                                    </div>
                                    <div class="site-right">
                                        <div class="site-stats">
                            <span>${floorCount} floors &bull; ${totalSwitches} switches</span>
                                        </div>
                                        <div class="site-actions">
                                            <button class="action-btn" onclick="event.stopPropagation(); editSite(${site.id}, '${escapedName}')" 
                                                title="Edit site">
                                                &#9999;&#65039;
                                            </button>
                            <div class="expand-icon">&#9654;</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="floors-container" id="floors-${site.id}">
                                ${renderFloors(site.floors, site.id, site.name)}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Helper function to format floor names with 'F' prefix for numeric floors
        function formatFloorName(floorName) {
            // Check if floor name is just a number (like "1", "2", "11", etc.)
            if (/^\d+$/.test(floorName)) {
                return `F${floorName}`;
            }
            // For non-numeric floors like "GF", "PH", "B1", etc., return as-is
            return floorName;
        }
        
        // Render floors for a site
        function renderFloors(floors, siteId, siteName) {
            if (floors.length === 0) {
                return '<div class="floor-item"><div class="floor-name">No floors configured</div></div>';
            }
            
            return floors.map(floor => {
                // Escape single quotes in floor name for onclick handlers
                const escapedName = floor.name.replace(/'/g, "\\'");
                const displayName = formatFloorName(floor.name);
                return `
                    <div class="floor-item" onclick="selectFloor('${siteId}', '${siteName}', '${floor.id}', '${floor.name}')" id="floor-${floor.id}">
                        <div class="floor-name">
                            <span>&#127970;</span>
                            <span>${displayName}</span>
                        </div>
                        <div class="floor-switch-count">
                            <button class="action-btn" onclick="event.stopPropagation(); editFloor(${floor.id}, '${escapedName}', ${siteId})" 
                                title="Edit floor">
                                &#9999;&#65039;
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Toggle site expansion and select site
        function toggleSite(siteId) {
            const header = document.getElementById(`site-header-${siteId}`);
            const floors = document.getElementById(`floors-${siteId}`);
            const expandIcon = header.querySelector('.expand-icon');
            
            // First, select this site (remove selection from other sites)
            document.querySelectorAll('.site-header').forEach(el => {
                el.classList.remove('selected');
            });
            header.classList.add('selected');
            
            // Store the selected site globally - get site name from sitesData array
            const siteData = sitesData.find(site => site.id == siteId);
            const siteName = siteData ? siteData.name : 'Unknown Site';
            window.selectedSiteId = siteId;
            window.selectedSiteName = siteName;
            
            // Clear any floor selection and hide Add Switch button
            document.querySelectorAll('.floor-item').forEach(item => {
                item.classList.remove('selected');
            });
            currentFloorData = null;
            
            // Hide the Add Switch button since no specific floor is selected
            const addSwitchBtn = document.getElementById('add-switch-btn');
            if (addSwitchBtn) {
                addSwitchBtn.style.display = 'none';
            }
            
            // Load all switches for this site
            loadSiteSwitches(siteId, siteName);
            
            // Show Add Floor button since site is selected
            showAddFloorButton(siteId);
            
            const isExpanded = floors.classList.contains('expanded');
            
            if (isExpanded) {
                floors.classList.remove('expanded');
                header.classList.remove('expanded');
            } else {
                // Close other expanded sites first
                document.querySelectorAll('.floors-container').forEach(el => {
                    el.classList.remove('expanded');
                });
                document.querySelectorAll('.site-header').forEach(el => {
                    if (el !== header) {
                        el.classList.remove('expanded');
                    }
                });
                
                floors.classList.add('expanded');
                header.classList.add('expanded');
            }
        }
        
        // Show Add Floor button for a specific site
        function showAddFloorButton(siteId) {
            const addFloorBtn = document.getElementById('add-floor-btn');
            if (addFloorBtn) {
                addFloorBtn.style.display = 'inline-block';
                // Store the currently selected site ID for the Add Floor functionality
                addFloorBtn.setAttribute('data-site-id', siteId);
            }
        }
        
        // Hide Add Floor button
        function hideAddFloorButton() {
            const addFloorBtn = document.getElementById('add-floor-btn');
            if (addFloorBtn) {
                addFloorBtn.style.display = 'none';
                addFloorBtn.removeAttribute('data-site-id');
            }
        }
        
        // Select a floor and load its switches
        async function selectFloor(siteId, siteName, floorId, floorName) {
            // Update selection state
            document.querySelectorAll('.floor-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.getElementById(`floor-${floorId}`).classList.add('selected');
            
            // Update breadcrumb and title
            updateContentHeader(siteName, floorName);
            
            // Store current selection
            currentSiteData = { id: siteId, name: siteName };
            currentFloorData = { id: floorId, name: floorName };
            
            // Show the Add Switch button since a floor is now selected
            const addSwitchBtn = document.getElementById('add-switch-btn');
            if (addSwitchBtn) {
                addSwitchBtn.style.display = 'flex';
            }
            
            // Load switches for this floor
            await loadFloorSwitches(floorId);
        }
        
        // Update content header for floor view
        function updateContentHeader(siteName, floorName) {
            const displayFloorName = formatFloorName(floorName);
            document.getElementById('current-site').textContent = siteName;
            document.getElementById('current-floor').textContent = displayFloorName;
            document.getElementById('current-floor').style.display = 'inline';
            document.getElementById('floor-separator').style.display = 'inline';
            
            document.getElementById('content-title').innerHTML = `
                <span>🏢</span>
                ${displayFloorName} - Switch Inventory
            `;
            
            document.getElementById('content-description').textContent = 
                `Viewing switches for ${displayFloorName} in ${siteName}`;
        }
        
        // Update content header for site view (all floors)
        function updateSiteContentHeader(siteName) {
            document.getElementById('current-site').textContent = siteName;
            document.getElementById('current-floor').style.display = 'none';
            document.getElementById('floor-separator').style.display = 'none';
            
            document.getElementById('content-title').innerHTML = `
                <span>&#127970;</span>
                ${siteName} - Switch Inventory
            `;
            
            document.getElementById('content-description').textContent = 
                `Viewing all switches for ${siteName} (aggregated across all floors)`;
        }
        
        // Load all switches for a specific site
        async function loadSiteSwitches(siteId, siteName) {
            try {
                // Show loading state
                document.getElementById('switches-content').innerHTML = `
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        Loading switches for ${siteName}...
                    </div>
                `;
                
                const response = await fetch('/api/switches');
                const data = await response.json();
                
                if (response.ok) {
                    // Filter switches for all floors in this site
                    allSwitches = data.filter(sw => sw.site_id == siteId);
                    filteredSwitches = [...allSwitches];
                    
                    // Update breadcrumb and header for site view
                    updateSiteContentHeader(siteName);
                    
                    renderSwitches();
                    updateStats();
                    
                    // Show controls
                    document.getElementById('switches-controls').style.display = 'flex';
                    document.getElementById('stats-grid').style.display = 'grid';
                } else {
                    showError('Failed to load switches: ' + data.error);
                }
            } catch (error) {
                showError('Error loading switches: ' + error.message);
            }
        }
        
        // Load switches for a specific floor
        async function loadFloorSwitches(floorId) {
            try {
                // Show loading state
                document.getElementById('switches-content').innerHTML = `
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        Loading switches...
                    </div>
                `;
                
                const response = await fetch('/api/switches');
                const data = await response.json();
                
                if (response.ok) {
                    // Filter switches for this floor
                    allSwitches = data.filter(sw => sw.floor_id == floorId);
                    filteredSwitches = [...allSwitches];
                    
                    renderSwitches();
                    updateStats();
                    
                    // Show controls
                    document.getElementById('switches-controls').style.display = 'flex';
                    document.getElementById('stats-grid').style.display = 'grid';
                } else {
                    showError('Failed to load switches: ' + data.error);
                }
            } catch (error) {
                showError('Error loading switches: ' + error.message);
            }
        }
        
        // Render switches table with proper filtering
        function renderSwitches(switchesToRender = null) {
            const content = document.getElementById('switches-content');
            const switches = switchesToRender || filteredSwitches || allSwitches || [];
            
            if (switches.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">&#128296;</div>
                        <div class="empty-title">No Switches Found</div>
                        <div class="empty-description">No switches match the current filter criteria</div>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table class="switches-table">
                    <thead>
                        <tr>
                            <th>Switch Name</th>
                            <th>Model</th>
                            <th>IP Address</th>
                            <th>Status</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            switches.forEach(sw => {
                const statusClass = sw.enabled ? 'active' : 'inactive';
                const statusIcon = sw.enabled ? '&#9989;' : '&#10060;';
                const statusText = sw.enabled ? 'Active' : 'Inactive';
                
                html += `
                    <tr>
                        <td>
                            <div class="switch-name">${sw.name}</div>
                        </td>
                        <td>${sw.model}</td>
                        <td><code class="switch-ip">${sw.ip_address}</code></td>
                        <td>
                            <span class="status-badge status-${statusClass}">
                                <span>${statusIcon}</span>
                                ${statusText}
                            </span>
                        </td>
                        <td>${sw.description || '-'}</td>
                        <td>
                            <div class="switch-actions">
                                <button class="action-btn" onclick="editSwitch(${sw.id})" title="Edit switch">
                                    &#9999;&#65039; Edit
                                </button>
                                <button class="action-btn" onclick="deleteSwitch(${sw.id}, '${sw.name.replace(/'/g, "\\'")}')"
                                    title="Delete switch" style="color: #dc3545; border-color: #dc3545;">
                                            &#128465;&#65039; Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            content.innerHTML = html;
        }
        
        // Update statistics
        function updateStats() {
            const total = allSwitches.length;
            const active = allSwitches.filter(sw => sw.enabled).length;
            const inactive = total - active;
            const models = new Set(allSwitches.map(sw => sw.model)).size;
            
            document.getElementById('total-switches').textContent = total;
            document.getElementById('active-switches').textContent = active;
            document.getElementById('inactive-switches').textContent = inactive;
            document.getElementById('unique-models').textContent = models;
        }
        
        // Handle search input
        function handleSearchInput(event) {
            const query = event.target.value.toLowerCase();
            
            filteredSwitches = allSwitches.filter(sw => 
                sw.name.toLowerCase().includes(query) ||
                sw.model.toLowerCase().includes(query) ||
                sw.ip_address.toLowerCase().includes(query) ||
                (sw.description && sw.description.toLowerCase().includes(query)) ||
                (sw.site_name && sw.site_name.toLowerCase().includes(query)) ||
                (sw.floor_name && sw.floor_name.toLowerCase().includes(query))
            );
            
            renderSwitches();
        }
        
        // Handle filter button clicks
        function handleFilterClick(event) {
            const filter = event.target.dataset.filter;
            
            // Update active filter button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Apply filter
            switch (filter) {
                case 'all':
                    filteredSwitches = [...allSwitches];
                    break;
                case 'active':
                    filteredSwitches = allSwitches.filter(sw => sw.enabled);
                    break;
                case 'inactive':
                    filteredSwitches = allSwitches.filter(sw => !sw.enabled);
                    break;
            }
            
            // Apply current search if any
            const searchQuery = document.getElementById('switch-search').value.toLowerCase();
            if (searchQuery) {
                filteredSwitches = filteredSwitches.filter(sw => 
                    sw.name.toLowerCase().includes(searchQuery) ||
                    sw.model.toLowerCase().includes(searchQuery) ||
                    sw.ip_address.toLowerCase().includes(searchQuery) ||
                    (sw.description && sw.description.toLowerCase().includes(searchQuery))
                );
            }
            
            renderSwitches();
        }
        
        // Switch action functions
        function viewSwitchDetails(switchId) {
            const sw = allSwitches.find(s => s.id === switchId);
            if (sw) {
                alert(`Switch Details:\n\nName: ${sw.name}\nModel: ${sw.model}\nIP: ${sw.ip_address}\nStatus: ${sw.enabled ? 'Active' : 'Inactive'}\nDescription: ${sw.description || 'None'}`);
            }
        }
        
        function editSwitch(switchId) {
            // Find the switch data
            const switchData = allSwitches.find(sw => sw.id == switchId);
            if (!switchData) {
                showError('Switch not found');
                return;
            }
            
            // Open edit modal instead of redirecting
            showEditSwitchModal(switchData);
        }
        
        // Site search functionality
        document.getElementById('site-search').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const siteItems = document.querySelectorAll('.tree-site');
            
            // If clearing search (empty term), collapse all sites (default behavior)
            if (!searchTerm) {
                siteItems.forEach(siteItem => {
                    const floorsContainer = siteItem.querySelector('.floors-container');
                    const siteHeader = siteItem.querySelector('.site-header');
                    
                    // Show all sites and floors
                    siteItem.parentElement.style.display = 'block';
                    siteItem.querySelectorAll('.floor-item').forEach(floor => {
                        floor.style.display = 'flex';
                    });
                    
                    // Default behavior: collapse all sites when clearing search
                    floorsContainer.classList.remove('expanded');
                    siteHeader.classList.remove('expanded');
                });
                return;
            }
            
            siteItems.forEach(siteItem => {
                // Fix: Use correct selector path for site name
                const siteNameElement = siteItem.querySelector('.site-header-content .site-left span:nth-child(2)');
                if (!siteNameElement) return; // Skip if element not found
                
                const siteName = siteNameElement.textContent.toLowerCase();
                const floorItems = siteItem.querySelectorAll('.floor-item');
                let hasVisibleFloors = false;
                
                // Filter floors within each site
                floorItems.forEach(floorItem => {
                    const floorNameElement = floorItem.querySelector('.floor-name span:nth-child(2)');
                    if (!floorNameElement) return; // Skip if element not found
                    
                    const floorName = floorNameElement.textContent.toLowerCase();
                    const shouldShow = siteName.includes(searchTerm) || floorName.includes(searchTerm);
                    floorItem.style.display = shouldShow ? 'flex' : 'none';
                    if (shouldShow) hasVisibleFloors = true;
                });
                
                // Show/hide entire site based on search
                const shouldShowSite = siteName.includes(searchTerm) || hasVisibleFloors;
                siteItem.parentElement.style.display = shouldShowSite ? 'block' : 'none';
                
                // Auto-expand sites that match search
                if (searchTerm && shouldShowSite) {
                    const floorsContainer = siteItem.querySelector('.floors-container');
                    const siteHeader = siteItem.querySelector('.site-header');
                    if (floorsContainer && siteHeader) {
                        floorsContainer.classList.add('expanded');
                        siteHeader.classList.add('expanded');
                    }
                }
            });
        });
        
        // Modal functions
        function showAddSiteModal() {
            const modal = createModal('Add Site', `
                <form id="add-site-form">
                    <div class="form-group">
                        <label for="new-site-name">Site Name</label>
                            <input type="text" id="new-site-name" name="name" required placeholder="e.g., NYC_MAIN" maxlength="50" 
                               pattern="^[A-Za-z0-9_-]+$" 
                               title="Only letters, numbers, underscores, and hyphens allowed. No spaces or special characters.">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn-primary">&#128179; Create Site</button>
                        <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `);
            
            document.getElementById('add-site-form').addEventListener('submit', handleAddSite);
        }
        
        function showAddFloorModal() {
            // Check if a site is selected either through site selection or floor selection
            let selectedSiteId = null;
            let selectedSiteName = null;
            
            if (currentSiteData) {
                // Floor was selected, use currentSiteData
                selectedSiteId = currentSiteData.id;
                selectedSiteName = currentSiteData.name;
            } else if (window.selectedSiteId && window.selectedSiteName) {
                // Only site was selected, use global selection
                selectedSiteId = window.selectedSiteId;
                selectedSiteName = window.selectedSiteName;
            }
            
            if (!selectedSiteId) {
                showToast('Please select a site first', 'error');
                return;
            }
            
            const modal = createModal('Add Floor', `
                <form id="add-floor-form">
                    <input type="hidden" id="floor-site-id" value="${selectedSiteId}">
                    <div class="form-group">
                        <label for="floor-site-name">Site</label>
                        <input type="text" id="floor-site-name" value="${selectedSiteName}" readonly>
                    </div>
                    <div class="form-group">
                        <label for="new-floor-name">Floor Name</label>
                        <input type="text" id="new-floor-name" name="name" required placeholder="e.g., Floor 1 or F1 or GF" maxlength="20" 
                               pattern="^(F[0-9]{1,2}|GF|PH|B[0-9]|Floor [0-9]{1,2}|[0-9]{1,2}|Ground Floor|Penthouse|Basement)$" 
                               title="Valid formats: F1-F99, GF, PH, B1-B9, Floor 1-99, 1-99, Ground Floor, Penthouse, or Basement">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn-primary">&#128179; Create Floor</button>
                        <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `);
            
            document.getElementById('add-floor-form').addEventListener('submit', handleAddFloor);
        }
        
        function showEditSwitchModal(switchData) {
            const modal = createModal('Edit Switch', `
                <form id="edit-switch-form">
                    <input type="hidden" id="edit-switch-id" value="${switchData.id}">
                    <div class="form-group">
                        <label for="edit-switch-name">Switch Name</label>
                        <input type="text" id="edit-switch-name" value="${switchData.name}" required maxlength="50" 
                               pattern="[A-Za-z0-9_-]+" 
                               title="Only letters, numbers, underscores, and hyphens allowed. Format: SITE-FLOOR-RACK-TYPE-NUMBER">
                    </div>
                    <div class="form-group">
                        <label for="edit-switch-ip">IP Address</label>
                        <input type="text" id="edit-switch-ip" value="${switchData.ip_address}" required 
                               pattern="^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$" 
                               title="Valid IPv4 address required (e.g., 192.168.1.100)">
                    </div>
                        <div class="form-group">
                            <label for="edit-switch-model">Model</label>
                            <select id="edit-switch-model" required>
                                <option value="">Select switch model...</option>
                                <optgroup label="Dell N2000 Series">
                                    <option value="Dell N2024" ${switchData.model === 'Dell N2024' ? 'selected' : ''}>Dell N2024</option>
                                    <option value="Dell N2048" ${switchData.model === 'Dell N2048' ? 'selected' : ''}>Dell N2048</option>
                                    <option value="Dell N2048P" ${switchData.model === 'Dell N2048P' ? 'selected' : ''}>Dell N2048P</option>
                                </optgroup>
                                <optgroup label="Dell N3000 Series">
                                    <option value="Dell N3024" ${switchData.model === 'Dell N3024' ? 'selected' : ''}>Dell N3024</option>
                                    <option value="Dell N3024P" ${switchData.model === 'Dell N3024P' ? 'selected' : ''}>Dell N3024P</option>
                                    <option value="Dell N3024F" ${switchData.model === 'Dell N3024F' ? 'selected' : ''}>Dell N3024F</option>
                                    <option value="Dell N3048" ${switchData.model === 'Dell N3048' ? 'selected' : ''}>Dell N3048</option>
                                    <option value="Dell N3048P" ${switchData.model === 'Dell N3048P' ? 'selected' : ''}>Dell N3048P</option>
                                </optgroup>
                                <optgroup label="Dell N3200 Series">
                                    <option value="Dell N3248" ${switchData.model === 'Dell N3248' ? 'selected' : ''}>Dell N3248</option>
                                    <option value="Dell N3224P" ${switchData.model === 'Dell N3224P' ? 'selected' : ''}>Dell N3224P</option>
                                    <option value="Dell N3224PXE" ${switchData.model === 'Dell N3224PXE' ? 'selected' : ''}>Dell N3224PXE</option>
                                    <option value="Dell N3248P" ${switchData.model === 'Dell N3248P' ? 'selected' : ''}>Dell N3248P</option>
                                    <option value="Dell N3248PXE" ${switchData.model === 'Dell N3248PXE' ? 'selected' : ''}>Dell N3248PXE</option>
                                </optgroup>
                                <optgroup label="Dell N4000 Series">
                                    <option value="Dell N4032" ${switchData.model === 'Dell N4032' ? 'selected' : ''}>Dell N4032</option>
                                    <option value="Dell N4032F" ${switchData.model === 'Dell N4032F' ? 'selected' : ''}>Dell N4032F</option>
                                    <option value="Dell N4064" ${switchData.model === 'Dell N4064' ? 'selected' : ''}>Dell N4064</option>
                                    <option value="Dell N4064F" ${switchData.model === 'Dell N4064F' ? 'selected' : ''}>Dell N4064F</option>
                                </optgroup>
                                <optgroup label="Dell S3000 Series">
                                    <option value="Dell S3048-ON" ${switchData.model === 'Dell S3048-ON' ? 'selected' : ''}>Dell S3048-ON</option>
                                    <option value="Dell S3124P" ${switchData.model === 'Dell S3124P' ? 'selected' : ''}>Dell S3124P</option>
                                    <option value="Dell S3124F" ${switchData.model === 'Dell S3124F' ? 'selected' : ''}>Dell S3124F</option>
                                </optgroup>
                                <optgroup label="Dell S4000 Series">
                                    <option value="Dell S4048-ON" ${switchData.model === 'Dell S4048-ON' ? 'selected' : ''}>Dell S4048-ON</option>
                                    <option value="Dell S4048T-ON" ${switchData.model === 'Dell S4048T-ON' ? 'selected' : ''}>Dell S4048T-ON</option>
                                    <option value="Dell S4112F-ON" ${switchData.model === 'Dell S4112F-ON' ? 'selected' : ''}>Dell S4112F-ON</option>
                                    <option value="Dell S4112T-ON" ${switchData.model === 'Dell S4112T-ON' ? 'selected' : ''}>Dell S4112T-ON</option>
                                    <option value="Dell S4128F-ON" ${switchData.model === 'Dell S4128F-ON' ? 'selected' : ''}>Dell S4128F-ON</option>
                                    <option value="Dell S4128T-ON" ${switchData.model === 'Dell S4128T-ON' ? 'selected' : ''}>Dell S4128T-ON</option>
                                </optgroup>
                                <optgroup label="Dell S5000 Series">
                                    <option value="Dell S5212F-ON" ${switchData.model === 'Dell S5212F-ON' ? 'selected' : ''}>Dell S5212F-ON</option>
                                    <option value="Dell S5224F-ON" ${switchData.model === 'Dell S5224F-ON' ? 'selected' : ''}>Dell S5224F-ON</option>
                                    <option value="Dell S5232F-ON" ${switchData.model === 'Dell S5232F-ON' ? 'selected' : ''}>Dell S5232F-ON</option>
                                    <option value="Dell S5248F-ON" ${switchData.model === 'Dell S5248F-ON' ? 'selected' : ''}>Dell S5248F-ON</option>
                                    <option value="Dell S5296F-ON" ${switchData.model === 'Dell S5296F-ON' ? 'selected' : ''}>Dell S5296F-ON</option>
                                </optgroup>
                                <optgroup label="Other Models">
                                    <option value="Custom Model" ${switchData.model === 'Custom Model' ? 'selected' : ''}>Custom Model (specify in description)</option>
                                </optgroup>
                            </select>
                        </div>
                    <div class="form-group">
                        <label for="edit-switch-description">Description</label>
                        <input type="text" id="edit-switch-description" value="${switchData.description || ''}" maxlength="100" 
                               pattern="[A-Za-z0-9 ._-]*" 
                               title="Only letters, numbers, spaces, periods, underscores, and hyphens allowed. No special characters.">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="edit-switch-enabled" ${switchData.enabled ? 'checked' : ''}>
                        <label for="edit-switch-enabled">Switch is enabled</label>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn-primary">&#128179; Update Switch</button>
                        <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `);
            
            document.getElementById('edit-switch-form').addEventListener('submit', handleEditSwitch);
        }
        
        function createModal(title, content) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>${title}</h3>
                        <button class="modal-close" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${content}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            return modal;
        }
        
        // Make function globally available
        window.createModal = createModal;
        
        function closeModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }
        
        // Make function globally available
        window.closeModal = closeModal;
        
        // Generic add switch modal when no floor is pre-selected
        function showGenericAddSwitchModal() {
            showToast('Please select a floor first', 'error');
        }
        
        // Helper function to open add switch modal with pre-selected floor
        function openAddSwitchModalWithFloor(floorId, floorName, siteName) {
            const modal = createModal('Add Switch to Floor', `
                <form id="add-switch-to-floor-form">
                    <input type="hidden" id="new-switch-floor-id" value="${floorId}">
                    <div class="form-group">
                        <label for="new-switch-site-name">Site</label>
                        <input type="text" id="new-switch-site-name" value="${siteName}" readonly>
                    </div>
                    <div class="form-group">
                        <label for="new-switch-floor-name">Floor</label>
                        <input type="text" id="new-switch-floor-name" value="${floorName}" readonly>
                    </div>
                    <div class="form-group">
                        <label for="new-switch-name">Switch Name</label>
                        <input type="text" id="new-switch-name" required placeholder="e.g., SITE_NAME-F11-R1-VAS-01" maxlength="50" 
                               pattern="[A-Z0-9_]+-F[0-9]{1,2}-[A-Z0-9]{1,3}-(VAS|AS)-[0-9]{1,2}$" 
                               title="Format: SITE_NAME-FLOOR-RACK/CABINET-VAS/AS-NUMBER (e.g., SITE_NAME-F11-R1-VAS-01 or SITE_NAME-F33-C1-AS-01)">
                    </div>
                    <div class="form-group">
                        <label for="new-switch-ip">IP Address</label>
                        <input type="text" id="new-switch-ip" required placeholder="e.g., 10.50.0.10" 
                               pattern="^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$">
                    </div>
                    <div class="form-group">
                        <label for="new-switch-model">Model</label>
                        <select id="new-switch-model" required>
                            <option value="">Select switch model...</option>
                            <optgroup label="Dell N2000 Series">
                                <option value="Dell N2024">Dell N2024</option>
                                <option value="Dell N2048">Dell N2048</option>
                                <option value="Dell N2048P">Dell N2048P</option>
                            </optgroup>
                            <optgroup label="Dell N3000 Series">
                                <option value="Dell N3024">Dell N3024</option>
                                <option value="Dell N3024P">Dell N3024P</option>
                                <option value="Dell N3024F">Dell N3024F</option>
                                <option value="Dell N3048">Dell N3048</option>
                                <option value="Dell N3048P">Dell N3048P</option>
                            </optgroup>
                            <optgroup label="Dell N3200 Series">
                                <option value="Dell N3248">Dell N3248</option>
                                <option value="Dell N3224P">Dell N3224P</option>
                                <option value="Dell N3224PXE">Dell N3224PXE</option>
                                <option value="Dell N3248P">Dell N3248P</option>
                                <option value="Dell N3248PXE">Dell N3248PXE</option>
                            </optgroup>
                            <optgroup label="Other Models">
                                <option value="Custom Model">Custom Model (specify in description)</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="new-switch-description">Description</label>
                        <input type="text" id="new-switch-description" placeholder="e.g., Floor 11 VAS Switch" maxlength="100" 
                               pattern="[A-Za-z0-9 ._-]*" 
                               title="Only letters, numbers, spaces, periods, underscores, and hyphens allowed. No special characters.">
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="new-switch-enabled" checked>
                        <label for="new-switch-enabled">Switch is enabled</label>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn-primary">&#128179; Add Switch</button>
                        <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `);
            
            document.getElementById('add-switch-to-floor-form').addEventListener('submit', handleAddSwitchToFloor);
        }
        
        // Handle add switch to floor form submission
        async function handleAddSwitchToFloor(e) {
            e.preventDefault();
            
            // Get floor ID from hidden input
            const floorId = document.getElementById('new-switch-floor-id').value;
            
            const data = {
                name: document.getElementById('new-switch-name').value,
                ip_address: document.getElementById('new-switch-ip').value,
                model: document.getElementById('new-switch-model').value,
                description: document.getElementById('new-switch-description').value,
                enabled: document.getElementById('new-switch-enabled').checked,
                floor_id: parseInt(floorId)
            };
            
            try {
                const response = await fetch('/api/switches', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (response.ok) {
                    showToast('Switch added successfully', 'success');
                    closeModal();
                    
                    // Refresh current floor switches if in detail view
                    if (typeof currentFloorData !== 'undefined' && currentFloorData) {
                        await loadFloorSwitches(currentFloorData.id);
                    }
                    
                    // Refresh main switches data if available
                    if (typeof loadSwitches === 'function') {
                        loadSwitches();
                    }
                    
                    // Refresh all switches data if available
                    if (typeof loadAllSwitches === 'function') {
                        await loadAllSwitches();
                    }
                    
                    // Refresh sidebar counts
                    if (typeof refreshSidebarCounts === 'function') {
                        await refreshSidebarCounts();
                    }
                } else {
                    showToast(result.error, 'error');
                }
            } catch (error) {
                console.error('Error adding switch:', error);
                showToast('Error adding switch', 'error');
            }
        }
        
        // Make functions globally available
        window.showGenericAddSwitchModal = showGenericAddSwitchModal;
        window.openAddSwitchModalWithFloor = openAddSwitchModalWithFloor;
        window.handleAddSwitchToFloor = handleAddSwitchToFloor;
        
        // Function to refresh switch counts in sidebar
        async function refreshSidebarCounts() {
            try {
                // Reload all switches data to get updated counts
                await loadAllSwitches();
                
                // Reload sites data to refresh the sidebar
                await loadSites();
                
                console.log('Sidebar counts refreshed successfully');
            } catch (error) {
                console.error('Error refreshing sidebar counts:', error);
            }
        }
        
        // Make function globally available
        window.refreshSidebarCounts = refreshSidebarCounts;
        
        // Form handlers
        async function handleAddSite(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch('/api/sites', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (response.ok) {
                    showToast('Site created successfully', 'success');
                    closeModal();
                    loadSites(); // Refresh the site list
                } else {
                    showToast(result.error, 'error');
                }
            } catch (error) {
                showToast('Error creating site', 'error');
            }
        }
        
        async function handleAddFloor(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // Use the site ID from the hidden field in the form
            const siteId = document.getElementById('floor-site-id').value;
            if (!siteId) {
                showToast('Site ID is missing. Please select a site again.', 'error');
                return;
            }
            data.site_id = siteId;
            
            try {
                const response = await fetch('/api/floors', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (response.ok) {
                    showToast('Floor created successfully', 'success');
                    closeModal();
                    loadSites(); // Refresh the site list
                } else {
                    showToast(result.error, 'error');
                }
            } catch (error) {
                showToast('Error creating floor', 'error');
            }
        }
        
        async function handleEditSwitch(e) {
            e.preventDefault();
            const switchId = document.getElementById('edit-switch-id').value;
            const data = {
                name: document.getElementById('edit-switch-name').value,
                ip_address: document.getElementById('edit-switch-ip').value,
                model: document.getElementById('edit-switch-model').value,
                description: document.getElementById('edit-switch-description').value,
                enabled: document.getElementById('edit-switch-enabled').checked
            };
            
            try {
                const response = await fetch(`/api/switches/${switchId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (response.ok) {
                    showToast('Switch updated successfully', 'success');
                    closeModal();
                    
                    // Immediately update the local switch data in allSwitches array
                    const switchIndex = allSwitches.findIndex(sw => sw.id == switchId);
                    if (switchIndex !== -1) {
                        // Update the switch data with the new values
                        allSwitches[switchIndex] = {
                            ...allSwitches[switchIndex],
                            name: data.name,
                            ip_address: data.ip_address,
                            model: data.model,
                            description: data.description,
                            enabled: data.enabled
                        };
                    }
                    
                    // Update filteredSwitches array as well
                    const filteredIndex = filteredSwitches.findIndex(sw => sw.id == switchId);
                    if (filteredIndex !== -1) {
                        filteredSwitches[filteredIndex] = {
                            ...filteredSwitches[filteredIndex],
                            name: data.name,
                            ip_address: data.ip_address,
                            model: data.model,
                            description: data.description,
                            enabled: data.enabled
                        };
                    }
                    
                    // Immediately re-render the table with updated data
                    renderSwitches();
                    updateStats();
                    
                    // Also refresh from server to ensure consistency (async in background)
                    setTimeout(async () => {
                        if (currentFloorData) {
                            await loadFloorSwitches(currentFloorData.id);
                        } else if (currentSiteData) {
                            await loadSiteSwitches(currentSiteData.id, currentSiteData.name);
                        }
                        // Refresh sidebar counts
                        if (typeof refreshSidebarCounts === 'function') {
                            await refreshSidebarCounts();
                        }
                    }, 100);
                } else {
                    showToast(result.error, 'error');
                }
            } catch (error) {
                showToast('Error updating switch', 'error');
            }
        }
        
        function deleteSwitch(switchId, switchName) {
            // Find the switch data
            const switchData = allSwitches.find(sw => sw.id == switchId);
            if (!switchData) {
                showToast('Switch not found', 'error');
                return;
            }
            
            // Show confirmation modal
            showDeleteSwitchModal(switchId, switchData);
        }
        
        // Toast notification system
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 4000);
        }
        
        // Make function globally available
        window.showToast = showToast;
        
        // Site and Floor edit/delete action functions
        function editSite(siteId, siteName) {
            // Open edit site modal or form
            const modal = createModal('Edit Site', `
                <form id="edit-site-form">
                    <input type="hidden" id="edit-site-id" value="${siteId}">
                    <div class="form-group">
                        <label for="edit-site-name">Site Name</label>
                        <input type="text" id="edit-site-name" name="name" value="${siteName}" required placeholder="e.g., NYC_MAIN" maxlength="50">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn-primary">&#128179; Update Site</button>
                        <button type="button" class="btn-danger" onclick="showDeleteSiteModal(${siteId}, '${siteName}')">&#128465;&#65039; Delete Site</button>
                        <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `);
            
            document.getElementById('edit-site-form').addEventListener('submit', handleEditSite);
        }
        
        function showDeleteSiteModal(siteId, siteName) {
            const modal = createDeleteModal(
                'Delete Site',
                `Are you sure you want to delete the site <span class="delete-item-name">"${siteName}"</span>?`,
                'This will also delete all floors and switches in this site. This action cannot be undone.',
                () => deleteSite(siteId, siteName)
            );
        }
        
        
        function editFloor(floorId, floorName, siteId) {
            // Find the site name for the current site
            const site = sitesData.find(s => s.id == siteId);
            const siteName = site ? site.name : 'Unknown Site';
            
            const modal = createModal('Edit Floor', `
                <form id="edit-floor-form">
                    <input type="hidden" id="edit-floor-id" value="${floorId}">
                    <div class="form-group">
                        <label for="edit-floor-site-name">Site</label>
                        <input type="text" id="edit-floor-site-name" value="${siteName}" readonly>
                    </div>
                    <div class="form-group">
                        <label for="edit-floor-name">Floor Name</label>
                        <input type="text" id="edit-floor-name" name="name" value="${floorName}" required placeholder="e.g., Floor 1" maxlength="20" 
                               pattern="^(F[0-9]{1,2}|GF|PH|B[0-9]|Floor [0-9]{1,2}|[0-9]{1,2}|Ground Floor|Penthouse|Basement)$" 
                               title="Valid formats: F1-F99, GF, PH, B1-B9, Floor 1-99, 1-99, Ground Floor, Penthouse, or Basement">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn-primary">&#128179; Update Floor</button>
                        <button type="button" class="btn-danger" onclick="deleteFloorFromModal(${floorId}, '${floorName}')">&#128465;&#65039; Delete Floor</button>
                        <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `);
            
            document.getElementById('edit-floor-form').addEventListener('submit', handleEditFloor);
        }
        
        function showDeleteSiteModal(siteId, siteName) {
            const modal = createDeleteModal(
                'Delete Site',
                `Are you sure you want to delete the site <span class="delete-item-name">"${siteName}"</span>?`,
                'This will also delete all floors and switches in this site. This action cannot be undone.',
                () => deleteSiteConfirmed(siteId, siteName)
            );
        }
        
        function deleteSiteConfirmed(siteId, siteName) {
            closeModal(); // Close the confirmation modal first
            
            fetch(`/api/sites/${siteId}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(result => {
                    if (result.error) {
                        showToast(result.error, 'error');
                    } else {
                        showToast(result.message, 'success');
                        loadSites(); // Refresh the site list
                        // Clear results and reset UI
                        document.getElementById('switches-content').innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">&#128269;</div>
                                <div class="empty-title">No Floor Selected</div>
                                <div class="empty-description">Choose a site and floor from the sidebar to view switch inventory</div>
                            </div>
                        `;
                        document.getElementById('switches-controls').style.display = 'none';
                        document.getElementById('stats-grid').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Error deleting site', 'error');
                });
        }
        
        function deleteFloorFromModal(floorId, floorName) {
            // This function is called from within the edit floor modal
            closeModal(); // Close the edit modal first
            
            // Show confirmation modal
            const modal = createDeleteModal(
                'Delete Floor',
                `Are you sure you want to delete the floor <span class="delete-item-name">"${floorName}"</span>?`,
                'This will also delete all switches on this floor. This action cannot be undone.',
                () => {
                    closeModal(); // Close the confirmation modal
                    
                    fetch(`/api/floors/${floorId}`, { method: 'DELETE' })
                        .then(response => response.json())
                        .then(result => {
                            if (result.error) {
                                showToast(result.error, 'error');
                            } else {
                                showToast(result.message, 'success');
                                loadSites(); // Refresh the site list
                                // Clear current floor selection if it was the deleted floor
                                if (currentFloorData && currentFloorData.id == floorId) {
                                    currentFloorData = null;
                                    document.getElementById('switches-content').innerHTML = `
                                        <div class="empty-state">
                                            <div class="empty-icon">&#128269;</div>
                                            <div class="empty-title">No Floor Selected</div>
                                            <div class="empty-description">Choose a site and floor from the sidebar to view switch inventory</div>
                                        </div>
                                    `;
                                    document.getElementById('switches-controls').style.display = 'none';
                                    document.getElementById('stats-grid').style.display = 'none';
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            showToast('Error deleting floor', 'error');
                        });
                }
            );
        }
        
        
        function showDeleteSwitchModal(switchId, switchData) {
            const modal = createDeleteModal(
                'Delete Switch',
                `Are you sure you want to delete the switch <span class="delete-item-name">"${switchData.name}"</span>?`,
                'This action cannot be undone. The switch will be removed from the inventory.',
                () => {
                    closeModal();
                    fetch(`/api/switches/${switchId}`, { method: 'DELETE' })
                        .then(response => response.json())
                        .then(result => {
                            if (result.error) {
                                showToast(result.error, 'error');
                            } else {
                                showToast(result.message, 'success');
                                // Refresh current floor or site switches
                                if (currentFloorData) {
                                    loadFloorSwitches(currentFloorData.id);
                                } else if (currentSiteData) {
                                    loadSiteSwitches(currentSiteData.id, currentSiteData.name);
                                }
                                // Refresh sidebar counts
                                if (typeof refreshSidebarCounts === 'function') {
                                    refreshSidebarCounts();
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            showToast('Error deleting switch', 'error');
                        });
                }
            );
        }
        
        // Form submission handlers for edit modals
        async function handleEditSite(e) {
            e.preventDefault();
            const siteId = document.getElementById('edit-site-id').value;
            const data = {
                name: document.getElementById('edit-site-name').value
            };
            
            try {
                const response = await fetch(`/api/sites/${siteId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (response.ok) {
                    showToast('Site updated successfully', 'success');
                    closeModal();
                    loadSites(); // Refresh the site list
                } else {
                    showToast(result.error, 'error');
                }
            } catch (error) {
                showToast('Error updating site', 'error');
            }
        }
        
        async function handleEditFloor(e) {
            e.preventDefault();
            const floorId = document.getElementById('edit-floor-id').value;
            const data = {
                name: document.getElementById('edit-floor-name').value
            };
            
            try {
                const response = await fetch(`/api/floors/${floorId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (response.ok) {
                    showToast('Floor updated successfully', 'success');
                    closeModal();
                    loadSites(); // Refresh the site list
                } else {
                    showToast(result.error, 'error');
                }
            } catch (error) {
                showToast('Error updating floor', 'error');
            }
        }
        
        // Create delete confirmation modal
        function createDeleteModal(title, message, warning, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay delete-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3><span>&#9888;&#65039;</span> ${title}</h3>
                        <button class="modal-close" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="delete-warning">
                            <div class="delete-warning-title">
                                <span>&#128680;</span> Warning
                            </div>
                            <div class="delete-warning-text">
                                ${message}
                            </div>
                            <div class="delete-warning-text">
                                ${warning}
                            </div>
                        </div>
                        <div class="delete-actions">
                            <button class="btn-cancel" onclick="closeModal()">Cancel</button>
                            <button class="btn-delete" id="confirm-delete-btn">&#128465;&#65039; Delete</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add event listener to delete button
            document.getElementById('confirm-delete-btn').addEventListener('click', onConfirm);
            
            return modal;
        }
        
        // Utility functions
        function showError(message) {
            document.getElementById('site-tree-container').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">&#10060;</div>
                    <div class="empty-title">Error</div>
                    <div class="empty-description">${message}</div>
                </div>
            `;
        }
    </script>
</body>
</html>

