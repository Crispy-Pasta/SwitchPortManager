<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced VLAN Management - Dell Switch Port Tracer</title>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='navigation.css') }}?v=1.1">
    <style>
        :root {
            --deep-navy: #001738;
            --orange: #FF7200;
            --light-blue: #CEDDEF;
            --rich-black: #111622;
            --white: #FFFFFF;
        }
        body {
            background: var(--deep-navy);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            position: relative;
        }
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        .header .subtitle {
            color: #7f8c8d;
            font-size: 1.1em;
        }
        .top-nav {
            text-align: center;
            margin-top: 10px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .top-nav a {
            color: #3498db;
            text-decoration: none;
            font-weight: 600;
            padding: 8px 12px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .top-nav a:hover {
            background-color: #ecf0f1;
            color: #2980b9;
        }
        .form-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 30px;
            border: none;
        }
        .form-section h3 {
            color: var(--orange);
            margin-bottom: 25px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
        }
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: flex-end;
        }
        .form-row.align-top {
            align-items: flex-start;
        }
        .form-row.align-center {
            align-items: center;
        }
        .form-group {
            flex: 1;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        /* Browser default placeholder styling */
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #9ca3af;
            opacity: 1;
        }
        .form-group.compact input, .form-group.compact select {
            max-width: 350px;
        }
        .form-group.medium input {
            max-width: 350px;
        }
        .form-group.small input {
            max-width: 120px;
        }
        .form-group.tiny input {
            max-width: 80px;
        }
        /* Force Select2 dropdown to respect max-width - specific to VLAN form only */
        .vlan-form .form-group.compact .select2-container {
            max-width: 350px !important;
            width: 350px !important;
        }
        /* Ensure Select2 dropdown maintains proper styling - specific to VLAN form only */
        .vlan-form .select2-container .select2-selection--single {
            border: 2px solid #ddd !important;
            border-radius: 8px !important;
        }
        /* Select2 base styling - proper text alignment and padding */
        body .container .form-section .vlan-form .select2-container .select2-selection--single,
        body #switch_select + .select2-container .select2-selection--single,
        body #workflow_type_select + .select2-container .select2-selection--single {
            height: 48px !important;
            line-height: 48px !important;
            display: flex !important;
            align-items: center !important;
        }
        
        /* Select2 rendered text - only style placeholders, not selected values */
        body .container .form-section .vlan-form .select2-container--default .select2-selection--single .select2-selection__rendered,
        body .container .form-section .vlan-form .select2-container .select2-selection--single .select2-selection__rendered,
        body #switch_select + .select2-container .select2-selection__rendered,
        body #workflow_type_select + .select2-container .select2-selection__rendered {
            padding-left: 12px !important;
            padding-right: 40px !important;
            font-weight: 400 !important;
            opacity: 1 !important;
            line-height: normal !important;
            color: inherit !important; /* Don't override selected text color */
        }
        
        /* Only style placeholder text, not selected values */
        body .container .form-section .vlan-form .select2-container--default .select2-selection--single .select2-selection__placeholder,
        body .container .form-section .vlan-form .select2-container .select2-selection--single .select2-selection__placeholder,
        body #switch_select + .select2-container .select2-selection__placeholder,
        body #workflow_type_select + .select2-container .select2-selection__placeholder {
            color: #9ca3af !important;
            font-weight: 400 !important;
            opacity: 1 !important;
            line-height: normal !important;
        }
        
        /* Target placeholder text by title attribute */
        body .container .select2-container--default .select2-selection--single .select2-selection__rendered[title*="Select"],
        body .container .select2-container--default .select2-selection--single .select2-selection__rendered[title*="Search"] {
            color: #9ca3af !important;
            font-weight: 400 !important;
            opacity: 1 !important;
            line-height: normal !important;
        }
        
        /* Ensure selected text has normal color */
        body .container .form-section .vlan-form .select2-container .select2-selection__rendered:not([title*="Select"]):not([title*="Search"]),
        body #switch_select + .select2-container .select2-selection__rendered:not([title*="Select"]):not([title*="Search"]),
        body #workflow_type_select + .select2-container .select2-selection__rendered:not([title*="Select"]):not([title*="Search"]) {
            color: #2c3e50 !important;
        }
        .vlan-form .select2-dropdown {
            border: 2px solid #3498db !important;
            border-radius: 8px !important;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        .form-group textarea {
            height: 80px;
            resize: vertical;
        }
        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--orange), #e68900);
            color: white;
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #e68900, #cc5500);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(255, 114, 0, 0.3);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
            border: none;
        }
        .btn-secondary:hover {
            background: linear-gradient(135deg, #5a6268, #495057);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(108, 117, 125, 0.3);
        }
        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            border: none;
        }
        .btn-warning:hover {
            background: linear-gradient(135deg, #e67e22, #d68910);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(243, 156, 18, 0.3);
        }
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
        }
        .btn-danger:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(231, 76, 60, 0.3);
        }
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            border: none;
        }
        .btn-success:hover {
            background: linear-gradient(135deg, #229954, #1e8449);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(39, 174, 96, 0.3);
        }
        .options-section {
            background: #fff8dc;
            border: 2px solid #f39c12;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }
        .options-section h4 {
            color: #d35400;
            margin-bottom: 15px;
            margin-top: 0;
            font-size: 1.2em;
        }
        .checkbox-group {
            display: flex;
            gap: 30px;
            margin-bottom: 15px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .checkbox-item input[type="checkbox"] {
            transform: scale(1.2);
        }
        .checkbox-item label {
            font-weight: 500;
            margin: 0;
        }
        .help-text {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
        .result-section {
            margin-top: 30px;
            padding: 20px;
            border-radius: 10px;
        }
        .result-success {
            background: #d5f4e6;
            border: 2px solid #27ae60;
            color: #155724;
        }
        .result-warning {
            background: #fff3cd;
            border: 2px solid #f39c12;
            color: #856404;
        }
        .result-error {
            background: #f8d7da;
            border: 2px solid #e74c3c;
            color: #721c24;
        }
        .result-info {
            background: #e8f4fd;
            border: 2px solid #3498db;
            color: #1c4e6b;
        }
        .confirmation-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            z-index: 1000;
        }
        .confirmation-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .confirmation-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }
        .confirmation-header .icon {
            font-size: 2em;
        }
        .confirmation-header h3 {
            margin: 0;
            color: #2c3e50;
        }
        .port-status-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .port-status-table th,
        .port-status-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .port-status-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .status-up {
            color: #27ae60;
            font-weight: bold;
        }
        .status-down {
            color: #7f8c8d;
        }
        .mode-access {
            color: #27ae60;
        }
        .mode-trunk, .mode-general {
            color: #f39c12;
            font-weight: bold;
        }
        .uplink-warning {
            color: #e74c3c;
            font-weight: bold;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: white;
            font-weight: 600;
        }
        .loading .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #3498db;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }
        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-top: 5px;
        }
        /* Header and Navigation Styles */
        .header-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 20px 30px;
            margin-bottom: 30px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(103, 126, 234, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid rgba(103, 126, 234, 0.3);
        }
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--orange), #e68900);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        .user-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .username {
            font-weight: 600;
            color: var(--deep-navy);
            font-size: 14px;
        }
        .user-role {
            font-size: 11px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .logout-btn {
            color: #dc2626;
            text-decoration: none;
            font-size: 12px;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        .logout-btn:hover {
            background: rgba(220, 38, 38, 0.1);
        }
        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .logo-section img {
            height: 60px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }
        .app-title {
            color: var(--deep-navy);
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }
        /* Navigation styles moved to global navigation.css file */
    </style>
</head>
<body>
    <div class="container">
        <div class="header-card">
            <div class="logo-section">
                <img src="{{ url_for('static', filename='img/kmc_logo.png') }}" alt="KMC Logo">
                <h1 class="app-title">Switch Port Tracer</h1>
            </div>
            <div class="user-profile">
                <div class="user-avatar">{{ username[0].upper() }}</div>
                <div class="user-details">
                    <div class="username">{{ username }}</div>
                    <div class="user-role">{{ user_role }}</div>
                </div>
                <a href="/logout" class="logout-btn">Logout</a>
            </div>
        </div>
        
        <div class="navigation-card">
            <div class="nav-links">
                <a href="/" class="nav-link">&#128269; Port Tracer</a>
                {% if user_role in ['netadmin', 'superadmin'] %}
                <a href="/vlan" class="nav-link active">&#128295; VLAN Manager</a>
                <a href="/inventory" class="nav-link">&#127970; Switch Management</a>
                {% endif %}
            </div>
        </div>

        <!-- Main VLAN Change Form -->
        <div class="form-section">
            <h3>📋 Port VLAN Assignment</h3>
            <form id="vlanChangeForm" class="vlan-form">
                <!-- Switch Selection -->
                <div class="form-row">
                    <div class="form-group compact">
                        <label for="switch_select">🖥️ Target Switch *</label>
                        <select id="switch_select" name="switch_id" required>
                            <option value="">Select a switch...</option>
                        </select>
                        <div class="help-text">Choose the switch where you want to change port VLANs</div>
                    </div>
                </div>

                <!-- Switch Model Display -->
                <div class="form-row" id="switch_model_row" style="display: none;">
                    <div class="form-group small">
                        <label for="switch_model_display">📡 Switch Model</label>
                        <input type="text" id="switch_model_display" readonly 
                               style="background-color: #f8f9fa; cursor: not-allowed;">
                        <div class="help-text">Detected switch model (affects port naming and uplink detection)</div>
                    </div>
                </div>

                <!-- Ports Input -->
                <div class="form-row" style="align-items: flex-start;">
                    <div class="form-group" style="flex: 3;">
                        <label for="ports_input">🔔 Ports *</label>
                        <input type="text" id="ports_input" name="ports" required 
                               placeholder="e.g., gi1/0/1-gi1/0/5, gi2/0/10, gi3/0/15-gi3/0/20">
                        <div class="help-text">
                            <strong>STRICT FORMAT:</strong> gix/x/x-gx/x/x where x=stack/port numbers.<br>
                            Use full interface names only. Separate multiple entries with commas. Uplink ports are protected.
                        </div>
                    </div>
                    <div style="flex: 0; display: flex; flex-direction: column; min-width: 130px;">
                        <div style="height: 31px;"></div>
                        <button type="button" id="checkPortsBtn" class="btn btn-secondary" style="width: 130px; height: 40px; padding: 8px 10px; font-size: 13px; white-space: nowrap;">
                            🔍 Check Ports
                        </button>
                    </div>
                </div>

                <!-- Port Description -->
                <div class="form-row">
                    <div class="form-group medium">
                        <label for="description_input">📝 Port Description *</label>
                        <input type="text" id="description_input" name="description" required
                               placeholder="e.g., Client Name, Room Location">
                        <div class="help-text">Description to set on the interfaces (required)</div>
                    </div>
                </div>

                <!-- Workflow Type Selection -->
                <div class="form-row">
                    <div class="form-group compact">
                        <label for="workflow_type_select">🔄 Workflow Type *</label>
                        <select id="workflow_type_select" name="workflow_type" required>
                            <option value="">Select workflow type...</option>
                            <option value="onboarding">🟢 Onboarding - Enable Ports</option>
                            <option value="offboarding">🔴 Offboarding - Shutdown Ports</option>
                        </select>
                        <div class="help-text">
                            <strong>Onboarding:</strong> After VLAN assignment, ports will be administratively enabled<br>
                            <strong>Offboarding:</strong> After VLAN assignment, ports will be administratively shutdown
                        </div>
                    </div>
                </div>

                <!-- VLAN Configuration -->
                <div style="display: flex; align-items: flex-start; gap: 24px; margin-bottom: 20px;">
                    <div style="flex: 0 0 110px;">
                        <label for="vlan_id_input" style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">🏷️ VLAN ID *</label>
                        <input type="number" id="vlan_id_input" name="vlan_id" required min="1" max="4094" 
                               placeholder="100" title="Enter VLAN ID between 1-4094" maxlength="4" 
                               style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;"
                               oninput="this.value=this.value.slice(0,4); if(parseInt(this.value)>4094) this.value=4094;">
                        <div class="help-text">1-4094 only</div>
                    </div>
                    <div style="flex: 1; max-width: 400px; margin-right: 8px;">
                        <label for="vlan_name_input" style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">🏷️ VLAN Name *</label>
                        <input type="text" id="vlan_name_input" name="vlan_name" required 
                               placeholder="e.g., Zone_Client_Name, Internal_Network"
                               style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                        <div class="help-text">VLAN name (creates/updates if needed)<br>
                            <small><strong>Naming Standards:</strong> Zone_Client_Name, Internal_Network, Guest_Access, IoT_Devices</small></div>
                    </div>
                    <div style="flex: 0 0 120px; margin-top: 31px; margin-left: -12px;">
                        <button type="button" id="checkVlanBtn" class="btn btn-secondary" style="width: 120px; height: 42px; padding: 8px 10px; font-size: 12px; white-space: nowrap; position: relative; z-index: 10;">
                            🔍 Check VLAN
                        </button>
                    </div>
                </div>

                <!-- Keep Existing VLAN Name Option -->
                <div style="margin-bottom: 20px; background: #e8f4fd; border: 2px solid #3498db; border-radius: 8px; padding: 15px;">
                    <div class="checkbox-item" style="margin-bottom: 10px;">
                        <input type="checkbox" id="keep_existing_vlan_name" name="keep_existing_vlan_name">
                        <label for="keep_existing_vlan_name" style="font-weight: 600; color: #2c3e50;">📝 Keep Existing VLAN Name</label>
                    </div>
                    <div class="help-text" style="color: #1c4e6b; margin-top: 5px;">
                        <strong>When enabled:</strong> Will not change the existing VLAN name on the switch. VLAN name field becomes optional.<br>
                        <strong>When disabled:</strong> VLAN name field is required for creating new VLANs or updating existing VLAN names.
                    </div>
                </div>
            </form>
        </div>

        <!-- Advanced Options -->
        <div class="options-section">
            <h4>⚙️ Advanced Safety Options</h4>
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="force_change" name="force_change">
                    <label for="force_change">🚨 Force Change All Ports</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="skip_non_access" name="skip_non_access">
                    <label for="skip_non_access">⏭️ Auto-skip Active or Non-Access Ports</label>
                </div>
            </div>
            <div class="help-text">
                <strong>Force Change:</strong> Will change all ports (except uplinks) regardless of status - requires confirmation.<br>
                <strong>Auto-skip Active or Non-Access:</strong> Will automatically skip ports that are UP or not in ACCESS mode.
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="btn-group">
            <button type="button" id="executeBtn" class="btn btn-primary">
                ⚡ Review and Execute Changes
            </button>
            <button type="button" id="clearBtn" class="btn btn-secondary">
                🗑️ Clear Form
            </button>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loading">
            <div class="spinner"></div>
            <p>Processing VLAN changes, please wait...</p>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="result-section" style="display: none;"></div>

    </div>

    <!-- Confirmation Dialog -->
    <div id="confirmationDialog" class="confirmation-dialog">
        <div class="confirmation-content">
            <div class="confirmation-header">
                <span class="icon">⚠️</span>
                <h3 id="confirmationTitle">Confirmation Required</h3>
            </div>
            <div id="confirmationMessage"></div>
            <div class="btn-group">
                <button id="confirmYes" class="btn btn-danger">✅ Yes, Proceed</button>
                <button id="confirmNo" class="btn btn-secondary">❌ Cancel</button>
            </div>
        </div>
    </div>

    <!-- VLAN Check Modal -->
    <div id="vlanCheckModal" class="confirmation-dialog">
        <div class="confirmation-content">
            <div class="confirmation-header">
                <span class="icon" id="vlanCheckIcon">🔍</span>
                <h3 id="vlanCheckTitle">VLAN Status Check</h3>
            </div>
            <div id="vlanCheckMessage"></div>
            <div class="btn-group">
                <button id="vlanCheckClose" class="btn btn-secondary">✅ Close</button>
            </div>
        </div>
    </div>

    <!-- Port Status Modal -->
    <div id="portStatusModal" class="confirmation-dialog">
        <div class="confirmation-content" style="max-width: 800px;">
            <div class="confirmation-header">
                <span class="icon">🔍</span>
                <h3 id="portStatusTitle">Port Status Check</h3>
            </div>
            <div id="portStatusMessage"></div>
            <div class="btn-group">
                <button id="portStatusClose" class="btn btn-secondary">✅ Close</button>
            </div>
        </div>
    </div>

    <!-- Preview Changes Modal -->
    <div id="previewModal" class="confirmation-dialog">
        <div class="confirmation-content" style="max-width: 1100px;">
            <div class="confirmation-header">
                <span class="icon">📋</span>
                <h3 id="previewTitle">VLAN Changes Preview</h3>
            </div>
            <div id="previewMessage"></div>
            <div class="btn-group">
                <button id="previewClose" class="btn btn-secondary">✅ Close</button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="confirmation-dialog">
        <div class="confirmation-content" style="max-width: 800px;">
            <div class="confirmation-header">
                <span class="icon">✅</span>
                <h3 id="successTitle">VLAN Change Completed Successfully</h3>
            </div>
            <div id="successMessage"></div>
            <div class="btn-group">
                <button id="successClose" class="btn btn-success">✅ Close</button>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="confirmation-dialog">
        <div class="confirmation-content" style="max-width: 400px; text-align: center;">
            <div class="confirmation-header" style="border-bottom: none; padding-bottom: 0;">
                <div class="loading-spinner" style="width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
            </div>
            <div id="loadingMessage" style="padding: 20px; font-size: 16px; font-weight: 600; color: #2c3e50;">Processing, please wait...</div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="alertModal" class="confirmation-dialog">
        <div class="confirmation-content" style="max-width: 450px;">
            <div class="confirmation-header" style="border-bottom: none; padding-bottom: 10px;">
                <span class="icon" id="alertIcon">⚠️</span>
                <h3 id="alertTitle" style="margin: 0; color: #2c3e50;">Validation Error</h3>
            </div>
            <div id="alertMessage" style="padding: 15px 0; font-size: 16px; color: #555; line-height: 1.4;"></div>
            <div class="btn-group" style="justify-content: center;">
                <button id="alertOk" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script>
        let currentWorkflowData = null;
        
        $(document).ready(function() {
            initializePage();
        });
        
        function initializePage() {
            // Initialize Select2 for switch selection
            $('#switch_select').select2({
                placeholder: 'Search and select a switch...',
                width: '350px',
                dropdownAutoWidth: true
            }).on('select2:select select2:unselect', function() {
                // Re-apply styling after selection changes
                setTimeout(forceSelect2PlaceholderStyling, 50);
            });
            
            // Initialize Select2 for workflow type selection (no search since only 2 options)
            $('#workflow_type_select').select2({
                placeholder: 'Select workflow type...',
                width: '350px',
                dropdownAutoWidth: true,
                minimumResultsForSearch: Infinity // Disable search box
            }).on('select2:select select2:unselect', function() {
                // Re-apply styling after selection changes
                setTimeout(forceSelect2PlaceholderStyling, 50);
            });
            
            // Force consistent placeholder styling after Select2 initialization
            setTimeout(function() {
                forceSelect2PlaceholderStyling();
            }, 200);
            
            // Load switches
            loadSwitches();
            
            // Bind events
            bindEvents();
        }
        
        function forceSelect2PlaceholderStyling() {
            // Force consistent styling for Select2 placeholders using JavaScript
            const placeholderColor = '#9ca3af';
            const selectedTextColor = '#2c3e50';
            
            // Only target elements with placeholder text (title attributes containing "Select" or "Search")
            $('[title*="Select"], [title*="Search"]').each(function() {
                if ($(this).hasClass('select2-selection__rendered')) {
                    $(this).css({
                        'color': placeholderColor + ' !important',
                        'font-weight': '400',
                        'opacity': '1'
                    });
                }
            });
            
            // Make sure selected values have proper text color
            $('.select2-selection__rendered').each(function() {
                const title = $(this).attr('title');
                // If it doesn't contain placeholder text, it's a selected value
                if (title && !title.includes('Select') && !title.includes('Search') && title.trim() !== '') {
                    $(this).css({
                        'color': selectedTextColor + ' !important',
                        'font-weight': '400',
                        'opacity': '1'
                    });
                }
            });
            
            console.log('Applied JavaScript-based Select2 styling - placeholders and selected values');
        }
        
        function bindEvents() {
            $('#executeBtn').on('click', startVlanChangeWorkflow);
            $('#clearBtn').on('click', clearForm);
            $('#checkPortsBtn').on('click', checkPortStatus);
            $('#checkVlanBtn').on('click', checkVlanStatus);
            $('#confirmYes').on('click', confirmAction);
            $('#confirmNo').on('click', closeConfirmation);
            
            // Close confirmation dialog on backdrop click
            $('#confirmationDialog').on('click', function(e) {
                if (e.target === this) {
                    closeConfirmation();
                }
            });
            
            // Modal event handlers
            $('#vlanCheckClose').on('click', closeVlanCheckModal);
            $('#portStatusClose').on('click', closePortStatusModal);
            $('#previewClose').on('click', closePreviewModal);
            $('#successClose').on('click', closeSuccessModal);
            $('#alertOk').on('click', closeAlertModal);
            
            // Close modals on backdrop click
            $('#vlanCheckModal, #portStatusModal, #previewModal, #successModal, #alertModal').on('click', function(e) {
                if (e.target === this) {
                    closeVlanCheckModal();
                    closePortStatusModal();
                    closePreviewModal();
                    closeSuccessModal();
                    closeAlertModal();
                }
            });
            
            // Handle keep existing VLAN name toggle
            $('#keep_existing_vlan_name').on('change', function() {
                const isChecked = $(this).is(':checked');
                const vlanNameInput = $('#vlan_name_input');
                
                if (isChecked) {
                    vlanNameInput.prop('required', false);
                    vlanNameInput.attr('placeholder', 'Will keep existing VLAN name (optional)');
                    vlanNameInput.parent().find('.help-text').html(
                        'VLAN name input is optional when keeping existing name<br>' + 
                        '<small><strong>Note:</strong> If VLAN exists, its current name will be preserved</small>'
                    );
                } else {
                    vlanNameInput.prop('required', true);
                    vlanNameInput.attr('placeholder', 'e.g., Zone_Client_Name, Internal_Network');
                    vlanNameInput.parent().find('.help-text').html(
                        'VLAN name (creates/updates if needed)<br>' + 
                        '<small><strong>Naming Standards:</strong> Zone_Client_Name, Internal_Network, Guest_Access, IoT_Devices</small>'
                    );
                }
            });
            
            // Ensure mutually exclusive safety options
            $('#force_change').on('change', function() {
                if ($(this).is(':checked')) {
                    $('#skip_non_access').prop('checked', false);
                }
            });
            
            $('#skip_non_access').on('change', function() {
                if ($(this).is(':checked')) {
                    $('#force_change').prop('checked', false);
                }
            });
        }
        
        function loadSwitches() {
            $.get('/api/switches/list')
                .done(function(data) {
                    const switchSelect = $('#switch_select');
                    switchSelect.empty().append('<option value="">Select a switch...</option>');
                    
                    data.forEach(function(switchData) {
                        switchSelect.append(
                            `<option value="${switchData.id}" 
                                    data-model="${switchData.model}" 
                                    data-ip="${switchData.ip_address}"
                                    data-site="${switchData.site_name}"
                                    data-floor="${switchData.floor_name}">
                                ${switchData.name} - ${switchData.ip_address}
                            </option>`
                        );
                    });
                    
                    // Add change handler for switch selection
                    $('#switch_select').on('change', function() {
                        const selectedOption = $(this).find('option:selected');
                        const switchId = selectedOption.val();
                        const switchModel = selectedOption.attr('data-model');
                        
                        console.log('Switch changed - ID:', switchId, 'Model:', switchModel, 'Option:', selectedOption);
                        
                        if (switchId && switchModel) {
                            console.log('Setting model display to:', switchModel);
                            $('#switch_model_display').val(switchModel);
                            $('#switch_model_row').show();
                            updatePortPlaceholder(switchModel);
                        } else {
                            console.log('Hiding model display');
                            $('#switch_model_display').val('');
                            $('#switch_model_row').hide();
                            resetPortPlaceholder();
                        }
                    });
                    
                    // Trigger change event if there's a pre-selected value
                    $('#switch_select').trigger('change');
                })
                .fail(function() {
                    showResult('error', 'Failed to load switches. Please refresh the page.');
                });
        }
        
        function updatePortPlaceholder(switchModel) {
            const portsInput = $('#ports_input');
            let placeholder = '';
            let helpText = '';
            
            console.log('Updating placeholder for model:', switchModel);
            
            if (switchModel.includes('N2048') || switchModel.includes('N2000')) {
                placeholder = 'e.g., gi1/0/1-gi1/0/5, gi2/0/10, gi3/0/15-gi3/0/20';
                helpText = '<strong>STRICT FORMAT:</strong> gix/x/x-gx/x/x where x=stack/port numbers. <br>Gi ports only (GigabitEthernet access ports). Te ports are uplinks and protected.';
            } else if (switchModel.includes('N3200') || switchModel.includes('N3248') || switchModel.includes('N32')) {
                placeholder = 'e.g., te1/0/1-te1/0/5, te2/0/10, te3/0/15-te3/0/20';
                helpText = '<strong>STRICT FORMAT:</strong> tex/x/x-tex/x/x where x=stack/port numbers. <br>Te ports only (TenGigabitEthernet access ports). Tw ports are uplinks and protected.';
            } else if (switchModel.includes('N30') || switchModel.includes('N3000')) {
                placeholder = 'e.g., gi1/0/1-gi1/0/5, gi2/0/10, gi3/0/15-gi3/0/20';
                helpText = '<strong>STRICT FORMAT:</strong> gix/x/x-gx/x/x where x=stack/port numbers. <br>Gi ports only (GigabitEthernet access ports). Te ports are uplinks and protected.';
            } else {
                placeholder = 'e.g., gi1/0/1-gi1/0/5, gi2/0/10, gi3/0/15-gi3/0/20';
                helpText = '<strong>STRICT FORMAT:</strong> gix/x/x-gx/x/x where x=stack/port numbers. <br>Gi ports only (GigabitEthernet access ports). Te ports are uplinks and protected.';
            }
            
            console.log('Setting placeholder:', placeholder);
            console.log('Setting help text:', helpText);
            
            portsInput.attr('placeholder', placeholder);
            portsInput.siblings('.help-text').html(helpText + '<br><strong>Important:</strong> Separate multiple entries with commas. All ports must use exact interface names.');
        }
        
        function resetPortPlaceholder() {
            $('#ports_input').attr('placeholder', 'e.g., gi1/0/1-gi1/0/5, gi2/0/10, gi3/0/15-gi3/0/20');
            $('#ports_input').siblings('.help-text').html('<strong>STRICT FORMAT:</strong> gix/x/x-gx/x/x where x=stack/port numbers. Select switch to see specific interface requirements.<br><strong>Important:</strong> Use full interface names only. Separate multiple entries with commas.');
        }
        
        function startVlanChangeWorkflow() {
            if (!validateForm()) return;
            
            const formData = getFormData();
            formData.preview_only = true; // Always start with a preview/review
            
            showLoadingModal('Reviewing changes, please wait...');
            
            // Use the VLAN change workflow in preview mode first
            $.ajax({
                url: '/api/vlan/change',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(result) {
                    hideLoadingModal();
                    showChangePreview(result, formData);
                },
                error: function(xhr) {
                    hideLoadingModal();
                    const error = xhr.responseJSON?.error || 'Failed to review changes';
                    showResult('error', `Review Error: ${error}`);
                }
            });
        }
        
        function checkPortStatus() {
            const switchId = $('#switch_select').val();
            const ports = $('#ports_input').val().trim();
            
            if (!switchId || !ports) {
                showAlert('⚠️', 'Input Required', 'Please select a switch and enter ports to check.');
                return;
            }
            
            showLoadingModal('Checking port status, please wait...');
            
            $.ajax({
                url: '/api/port/status',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    switch_id: switchId,
                    ports: ports
                }),
                success: function(result) {
                    hideLoadingModal();
                    showPortStatusResult(result);
                },
                error: function(xhr) {
                    hideLoadingModal();
                    const error = xhr.responseJSON?.error || 'Failed to check port status';
                    showResult('error', `Port Check Error: ${error}`);
                }
            });
        }
        
        function checkVlanStatus() {
            const switchId = $('#switch_select').val();
            const vlanId = $('#vlan_id_input').val();
            
            if (!switchId || !vlanId) {
                showAlert('⚠️', 'Input Required', 'Please select a switch and enter a VLAN ID to check.');
                return;
            }
            
            showLoadingModal('Checking VLAN status, please wait...');
            
            $.ajax({
                url: '/api/vlan/check',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    switch_id: switchId,
                    vlan_id: vlanId
                }),
                success: function(result) {
                    hideLoadingModal();
                    const status = result.exists ? 'exists' : 'will be created';
                    const name = result.exists ? result.name : 'N/A';
                    showVlanCheckModal(vlanId, status, name, result.exists);
                },
                error: function(xhr) {
                    hideLoadingModal();
                    const error = xhr.responseJSON?.error || 'Failed to check VLAN';
                    showVlanCheckModal(vlanId, 'error', error, false, true);
                }
            });
        }
        
        function handleWorkflowResult(result) {
            currentWorkflowData = result;
            
            if (result.status === 'confirmation_needed') {
                showConfirmationDialog(result);
            } else if (result.status === 'success') {
                showSuccessResult(result);
            } else if (result.status === 'error') {
                showResult('error', result.error || 'Unknown error occurred');
            }
        }
        
        function showConfirmationDialog(result) {
            let title, message;
            
            if (result.type === 'uplink_protection') {
                title = '🚨 Uplink Port Protection';
                message = `
                    <p><strong>Warning:</strong> ${result.message}</p>
                    <p>${result.details}</p>
                    <p><strong>Uplink ports detected:</strong> ${result.uplink_ports.join(', ')}</p>
                    <p><strong>Safe ports to change:</strong> ${result.safe_ports.length > 0 ? result.safe_ports.join(', ') : 'None'}</p>
                    <p>Do you want to proceed with only the safe ports?</p>
                `;
            } else if (result.type === 'active_or_non_access_ports') {
                title = 'Active or Non-Access Mode Ports Detected';
                message = `
                    <p><strong>${result.message}</strong></p>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table class="port-status-table">
                            <thead>
                                <tr>
                                    <th>Port</th>
                                    <th>Status</th>
                                    <th>Mode</th>
                                    <th>Current VLAN</th>
                                    <th>Issue</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                result.active_or_non_access_ports.forEach(function(portInfo) {
                    const status = portInfo.current_status;
                    message += `
                        <tr>
                            <td>${status.port}</td>
                            <td class="status-${status.status}">${status.status.toUpperCase()}</td>
                            <td class="mode-${status.mode}">${status.mode.toUpperCase()}</td>
                            <td>${status.current_vlan}</td>
                            <td>${portInfo.reason}</td>
                        </tr>
                    `;
                });
                
                message += `
                            </tbody>
                        </table>
                    </div>
                    <p><strong>Safe ports:</strong> ${result.safe_ports.length > 0 ? result.safe_ports.join(', ') : 'None'}</p>
                    <p>Do you want to proceed anyway? This will change all ports including the active or non-access mode ones.</p>
                `;
            }
            
            $('#confirmationTitle').text(title);
            $('#confirmationMessage').html(message);
            $('#confirmationDialog').show();
        }
        
        function confirmAction() {
            // Store the workflow data before closing confirmation (which sets it to null)
            const workflowData = currentWorkflowData;
            closeConfirmation();
            
            if (workflowData && workflowData.status === 'confirmation_needed') {
                // Re-execute with force or skip flags based on the confirmation type
                const formData = getFormData();
                
                if (workflowData.type === 'uplink_protection') {
                    // Proceed with safe ports only (don't set force_change)
                    formData.force_change = false;
                } else if (workflowData.type === 'active_or_non_access_ports') {
                    // Force change all ports
                    formData.force_change = true;
                }
                
                showLoadingModal('Processing VLAN changes, please wait...');
                
                $.ajax({
                    url: '/api/vlan/change',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function(result) {
                        hideLoadingModal();
                        handleWorkflowResult(result);
                    },
                    error: function(xhr) {
                        hideLoadingModal();
                        const error = xhr.responseJSON?.error || 'Unknown error occurred';
                        showResult('error', `Error: ${error}`);
                    }
                });
            }
        }
        
        function closeConfirmation() {
            $('#confirmationDialog').hide();
            currentWorkflowData = null;
        }
        
        function showSuccessResult(result) {
            showSuccessModal(result);
        }
        
        function showPortPreview(result) {
            showPortStatusModal(result);
        }
        
        function showChangePreview(result, formData) {
            if (result.status === 'success') {
                // Show preview in modal
                showPreviewModal(result, formData);
            } else if (result.status === 'confirmation_needed') {
                // Store the workflow data before showing confirmation dialog
                currentWorkflowData = result;
                // Show the preview with the confirmation details
                showConfirmationDialog(result);
            } else if (result.status === 'error') {
                showResult('error', `Preview failed: ${result.error || 'Unknown error occurred'}`);
            } else {
                // Fallback - treat as basic port status
                if (result.ports) {
                    showPortPreview(result);
                } else {
                    showResult('error', 'Unexpected preview result format');
                }
            }
        }
        
        function showPortStatusResult(result) {
            showPortPreview(result);
        }
        
        function validateForm() {
            const switchId = $('#switch_select').val();
            const ports = $('#ports_input').val().trim();
            const description = $('#description_input').val().trim();
            const workflowType = $('#workflow_type_select').val();
            const vlanIdInput = $('#vlan_id_input').val();
            const vlanId = parseInt(vlanIdInput);
            const vlanName = $('#vlan_name_input').val().trim();
            
            if (!switchId) {
                showAlert('⚠️', 'Switch Required', 'Please select a target switch from the dropdown.');
                return false;
            }
            
            if (!ports) {
                showAlert('⚠️', 'Ports Required', 'Please enter the port range or individual ports to configure.');
                return false;
            }
            
            if (!description) {
                showAlert('⚠️', 'Description Required', 'Please enter a description for the port configuration.');
                setTimeout(() => $('#description_input').focus(), 300);
                return false;
            }
            
            // Workflow Type validation
            if (!workflowType) {
                showAlert('⚠️', 'Workflow Type Required', 'Please select a workflow type (Onboarding or Offboarding).');
                setTimeout(() => $('#workflow_type_select').focus(), 300);
                return false;
            }
            
            // Enhanced VLAN ID validation
            if (!vlanIdInput || vlanIdInput.trim() === '') {
                showAlert('⚠️', 'VLAN ID Required', 'Please enter a VLAN ID between 1 and 4094.');
                setTimeout(() => $('#vlan_id_input').focus(), 300);
                return false;
            }
            
            if (isNaN(vlanId) || vlanId < 1 || vlanId > 4094) {
                showAlert('❌', 'Invalid VLAN ID', 'VLAN ID must be a number between 1 and 4094.');
                setTimeout(() => $('#vlan_id_input').focus().select(), 300);
                return false;
            }
            
            if (vlanIdInput.length > 4 || vlanId > 4094) {
                showAlert('❌', 'VLAN ID Too Large', 'VLAN ID cannot exceed 4094. The value has been corrected.');
                $('#vlan_id_input').val(4094);
                setTimeout(() => $('#vlan_id_input').focus().select(), 300);
                return false;
            }
            
            // Check if keep existing VLAN name is enabled
            const keepExistingVlanName = $('#keep_existing_vlan_name').is(':checked');
            
            if (!keepExistingVlanName && !vlanName) {
                showAlert('⚠️', 'VLAN Name Required', 'Please enter a VLAN name or enable the "Keep Existing VLAN Name" option.');
                return false;
            }
            
            return true;
        }
        
        function getFormData() {
            return {
                switch_id: parseInt($('#switch_select').val()),
                ports: $('#ports_input').val().trim(),
                description: $('#description_input').val().trim(),
                workflow_type: $('#workflow_type_select').val(),
                vlan_id: parseInt($('#vlan_id_input').val()),
                vlan_name: $('#vlan_name_input').val().trim(),
                force_change: $('#force_change').is(':checked'),
                skip_non_access: $('#skip_non_access').is(':checked'),
                keep_existing_vlan_name: $('#keep_existing_vlan_name').is(':checked')
            };
        }
        
        function clearForm() {
            $('#vlanChangeForm')[0].reset();
            $('#switch_select').val(null).trigger('change');
            $('#force_change, #skip_non_access').prop('checked', false);
            hideResults();
        }
        
        function showLoading(show, message) {
            if (show) {
                // Update loading message if provided
                if (message) {
                    $('#loadingIndicator p').text(message);
                }
                $('#loadingIndicator').show();
                $('#executeBtn').prop('disabled', true);
            } else {
                $('#loadingIndicator').hide();
                $('#executeBtn').prop('disabled', false);
                // Reset to default message
                $('#loadingIndicator p').text('Processing VLAN changes, please wait...');
            }
        }
        
        function showResult(type, message) {
            const resultsSection = $('#resultsSection');
            resultsSection.removeClass('result-success result-warning result-error');
            resultsSection.addClass('result-' + type);
            resultsSection.html(message);
            resultsSection.show();
            
            // Scroll to results
            resultsSection[0].scrollIntoView({ behavior: 'smooth' });
        }
        
        function hideResults() {
            $('#resultsSection').hide();
        }
        
        // Modal functions
        function showVlanCheckModal(vlanId, status, name, exists, isError = false) {
            let icon, title, message;
            
            if (isError) {
                icon = '❌';
                title = `VLAN ${vlanId} Check Failed`;
                message = `
                    <div style="background: #f8d7da; border: 1px solid #dc3545; border-radius: 6px; padding: 15px; margin: 10px 0;">
                        <p><strong>Error:</strong> ${name}</p>
                        <p>Unable to verify VLAN ${vlanId} existence on the selected switch. Please check your connection and try again.</p>
                    </div>
                `;
            } else {
                icon = exists ? '✅' : '📋';
                title = `VLAN ${vlanId} Status Check`;
                const statusColor = exists ? '#28a745' : '#007bff';
                message = `
                    <div style="background: ${exists ? '#d4edda' : '#cce7ff'}; border: 1px solid ${statusColor}; border-radius: 6px; padding: 15px; margin: 10px 0;">
                        <p><strong>Status:</strong> VLAN ${vlanId} <strong>${status}</strong> on the selected switch.</p>
                        <p><strong>Current name:</strong> <strong>${name}</strong></p>
                        <p><em>${exists ? '✅ VLAN already exists and can be used immediately.' : '📋 VLAN will be created automatically when you execute the VLAN change.'}</em></p>
                    </div>
                `;
            }
            
            $('#vlanCheckIcon').text(icon);
            $('#vlanCheckTitle').text(title);
            $('#vlanCheckMessage').html(message);
            $('#vlanCheckModal').show();
        }
        
        function closeVlanCheckModal() {
            $('#vlanCheckModal').hide();
        }
        
        function showPortStatusModal(result) {
            let html = `
                <h4>${result.switch_model} Switch Port Status</h4>
                <table class="port-status-table">
                    <thead>
                        <tr>
                            <th>Port</th>
                            <th>Status</th>
                            <th>Mode</th>
                            <th>Current VLAN</th>
                            <th>Uplink</th>
                            <th>Safety</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            result.ports.forEach(function(port) {
                let cautionClass = '';
                let caution = '';
                
                if (port.is_uplink) {
                    cautionClass = 'uplink-warning';
                    caution = '🚨 Uplink';
                } else if (port.status === 'up' || port.mode !== 'access') {
                    cautionClass = 'mode-trunk';
                    caution = '⚠️ Active/Non-Access';
                } else {
                    cautionClass = '';
                    caution = '✅ Safe';
                }
                
                html += `
                    <tr class="${cautionClass}">
                        <td>${port.port}</td>
                        <td class="status-${port.status}">${port.status.toUpperCase()}</td>
                        <td class="mode-${port.mode}">${port.mode.toUpperCase()}</td>
                        <td>${port.current_vlan}</td>
                        <td>${port.is_uplink ? '🚨 Yes' : '✅ No'}</td>
                        <td>${caution}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <p class="help-text" style="margin: 0; font-size: 13px; color: #666;">
                        🚨 <strong>Uplink ports</strong> are protected and will not be changed.<br>
                        ⚠️ <strong>Active or Non-Access ports</strong> are UP or not in ACCESS mode - require confirmation.<br>
                        ✅ <strong>Safe ports</strong> are DOWN and in ACCESS mode - can be changed safely.
                    </p>
                </div>
            `;
            
            $('#portStatusMessage').html(html);
            $('#portStatusModal').show();
        }
        
        function closePortStatusModal() {
            $('#portStatusModal').hide();
        }
        
        function showPreviewModal(result, formData) {
            let html = `
                <h4>${result.switch_info.name} - VLAN Changes Preview</h4>
                <div class="summary-stats">
                    <div class="stat-item">
                        <div class="stat-number">${result.summary.changed}</div>
                        <div class="stat-label">Ports to Change</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${result.summary.skipped}</div>
                        <div class="stat-label">Would Skip</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${result.summary.uplink_protected}</div>
                        <div class="stat-label">Uplink Protected</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${result.summary.failed}</div>
                        <div class="stat-label">Failed/Issues</div>
                    </div>
                </div>
                
                <div style="background: #e8f4fd; border: 1px solid #3498db; border-radius: 6px; padding: 15px; margin: 15px 0;">
                    <h5>📋 Planned Changes</h5>
                    <p><strong>Target VLAN:</strong> ${formData.vlan_id} - ${formData.vlan_name}</p>
                    <p><strong>Port Description:</strong> ${formData.description}</p>
                    <p><strong>Switch:</strong> ${result.switch_info.name} (${result.switch_info.site_name} - ${result.switch_info.floor_name})</p>
            `;
            
            if (result.vlan_operation_result) {
                html += `<p><strong>VLAN Operation:</strong> ${result.vlan_operation_result}</p>`;
            }
            
            html += `</div>`;
            
            if (result.ports_changed.length > 0) {
                html += `
                    <div style="background: #d4edda; border: 1px solid #28a745; border-radius: 6px; padding: 12px; margin: 10px 0;">
                        <h6 style="color: #155724; margin: 0 0 8px 0;">✅ Ports Ready to Change</h6>
                        <p style="margin: 0;"><strong>These ports will be changed:</strong> ${result.ports_changed.join(', ')}</p>
                    </div>
                `;
            }
            
            if (result.ports_skipped.length > 0) {
                html += `
                    <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 12px; margin: 10px 0;">
                        <h6 style="color: #856404; margin: 0 0 8px 0;">⏭️ Ports Would Be Skipped</h6>
                        <p style="margin: 0;"><strong>These ports would be skipped:</strong> ${result.ports_skipped.join(', ')}</p>
                        <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">Reasons: Uplink protection, active or non-access mode status, or user settings</p>
                    </div>
                `;
            }
            
            if (result.ports_failed.length > 0) {
                html += `
                    <div style="background: #f8d7da; border: 1px solid #dc3545; border-radius: 6px; padding: 12px; margin: 10px 0;">
                        <h6 style="color: #721c24; margin: 0 0 8px 0;">❌ Issues Detected</h6>
                        <p style="margin: 0;"><strong>These ports have issues:</strong> ${result.ports_failed.join(', ')}</p>
                        <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">These ports may require attention or manual intervention</p>
                    </div>
                `;
            }
            
            html += `
                <div style="background: #f8f9fa; border: 1px solid #6c757d; border-radius: 6px; padding: 12px; margin: 15px 0;">
                    <h6 style="color: #495057; margin: 0 0 8px 0;">ℹ️ Preview Summary</h6>
                    <p style="margin: 0;">This is a <strong>preview only</strong> - no actual changes have been made to the switch.</p>
                    <p style="margin: 5px 0 0 0;">Ready to execute? Click "Execute Changes" below to apply these changes to the switch.</p>
                </div>
            `;
            
            $('#previewMessage').html(html);
            
            // Update the preview modal buttons to include an execute option
            $('#previewModal .btn-group').html(`
                <button id="executeFromPreview" class="btn btn-primary">⚡ Execute Changes</button>
                <button id="previewClose" class="btn btn-secondary">✅ Close</button>
            `);
            
            // Bind the execute button event
            $('#executeFromPreview').on('click', function() {
                closePreviewModal();
                executeChangesFromPreview(formData);
            });
            
            // Re-bind the close button event
            $('#previewClose').on('click', closePreviewModal);
            
            $('#previewModal').show();
        }
        
        function executeChangesFromPreview(formData) {
            // Remove preview_only flag and execute the actual changes
            const executeFormData = { ...formData };
            delete executeFormData.preview_only;
            
            showLoadingModal('Executing VLAN changes, please wait...');
            
            $.ajax({
                url: '/api/vlan/change',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(executeFormData),
                success: function(result) {
                    hideLoadingModal();
                    handleWorkflowResult(result);
                },
                error: function(xhr) {
                    hideLoadingModal();
                    const error = xhr.responseJSON?.error || 'Failed to execute changes';
                    showResult('error', `Execution Error: ${error}`);
                }
            });
        }
        
        function closePreviewModal() {
            $('#previewModal').hide();
        }
        
        function showSuccessModal(result) {
            let html = `
                <div class="summary-stats">
                    <div class="stat-item">
                        <div class="stat-number">${result.summary.changed}</div>
                        <div class="stat-label">Ports Changed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${result.summary.failed}</div>
                        <div class="stat-label">Failed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${result.summary.skipped}</div>
                        <div class="stat-label">Skipped</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${result.summary.uplink_protected}</div>
                        <div class="stat-label">Uplink Protected</div>
                    </div>
                </div>
                
                <div style="background: #e8f4fd; border: 1px solid #3498db; border-radius: 6px; padding: 15px; margin: 15px 0;">
                    <h5>📋 Operation Details</h5>
                    <p><strong>Switch:</strong> ${result.switch_info.name} (${result.switch_info.site_name} - ${result.switch_info.floor_name})</p>
                    <p><strong>VLAN:</strong> ${result.vlan_id} - ${result.vlan_name}</p>
            `;
            
            if (result.vlan_operation_result) {
                html += `<p><strong>VLAN Operation:</strong> ${result.vlan_operation_result}</p>`;
            }
            
            html += `</div>`;
            
            if (result.ports_changed.length > 0) {
                html += `
                    <div style="background: #d4edda; border: 1px solid #28a745; border-radius: 6px; padding: 12px; margin: 10px 0;">
                        <h6 style="color: #155724; margin: 0 0 8px 0;">✅ Ports Successfully Changed</h6>
                        <p style="margin: 0;"><strong>Changed ports:</strong> ${result.ports_changed.join(', ')}</p>
                    </div>
                `;
            }
            
            if (result.ports_failed.length > 0) {
                html += `
                    <div style="background: #f8d7da; border: 1px solid #dc3545; border-radius: 6px; padding: 12px; margin: 10px 0;">
                        <h6 style="color: #721c24; margin: 0 0 8px 0;">❌ Failed Ports</h6>
                        <p style="margin: 0;"><strong>Failed ports:</strong> ${result.ports_failed.join(', ')}</p>
                    </div>
                `;
            }
            
            if (result.ports_skipped.length > 0) {
                html += `
                    <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 12px; margin: 10px 0;">
                        <h6 style="color: #856404; margin: 0 0 8px 0;">⏭️ Skipped Ports</h6>
                        <p style="margin: 0;"><strong>Skipped ports:</strong> ${result.ports_skipped.join(', ')}</p>
                        <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">Reasons: Uplink protection, active ports, or user settings</p>
                    </div>
                `;
            }
            
            $('#successMessage').html(html);
            $('#successModal').show();
        }
        
        function closeSuccessModal() {
            $('#successModal').hide();
        }
        
        // Loading Modal functions
        function showLoadingModal(message) {
            $('#loadingMessage').text(message || 'Processing, please wait...');
            $('#loadingModal').show();
        }
        
        function hideLoadingModal() {
            $('#loadingModal').hide();
        }
        
        // Alert Modal functions
        function showAlert(icon, title, message) {
            $('#alertIcon').text(icon);
            $('#alertTitle').text(title);
            $('#alertMessage').text(message);
            $('#alertModal').show();
        }
        
        function closeAlertModal() {
            $('#alertModal').hide();
        }
    </script>
</body>
</html>
