<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced VLAN Management - Dell Switch Port Tracer</title>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='navigation.css') }}?v=1.0">
    <style>
        :root {
            --deep-navy: #001738;
            --orange: #FF7200;
            --light-blue: #CEDDEF;
            --rich-black: #111622;
            --white: #FFFFFF;
        }
        body {
            background: var(--deep-navy);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            position: relative;
        }
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        .header .subtitle {
            color: #7f8c8d;
            font-size: 1.1em;
        }
        .top-nav {
            text-align: center;
            margin-top: 10px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .top-nav a {
            color: #3498db;
            text-decoration: none;
            font-weight: 600;
            padding: 8px 12px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .top-nav a:hover {
            background-color: #ecf0f1;
            color: #2980b9;
        }
        .form-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 30px;
            border: none;
        }
        .form-section h3 {
            color: var(--orange);
            margin-bottom: 25px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
        }
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: flex-end;
        }
        .form-row.align-top {
            align-items: flex-start;
        }
        .form-row.align-center {
            align-items: center;
        }
        .form-group {
            flex: 1;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        .form-group.compact input, .form-group.compact select {
            max-width: 350px;
        }
        .form-group.medium input {
            max-width: 350px;
        }
        .form-group.small input {
            max-width: 120px;
        }
        .form-group.tiny input {
            max-width: 80px;
        }
        /* Force Select2 dropdown to respect max-width - specific to VLAN form only */
        .vlan-form .form-group.compact .select2-container {
            max-width: 350px !important;
            width: 350px !important;
        }
        /* Ensure Select2 dropdown maintains proper styling - specific to VLAN form only */
        .vlan-form .select2-container .select2-selection--single {
            border: 2px solid #ddd !important;
            border-radius: 8px !important;
        }
        .vlan-form .select2-container--default .select2-selection--single .select2-selection__rendered {
            padding-left: 12px !important;
            padding-right: 40px !important;
            color: #333 !important;
        }
        .vlan-form .select2-dropdown {
            border: 2px solid #3498db !important;
            border-radius: 8px !important;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        .form-group textarea {
            height: 80px;
            resize: vertical;
        }
        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--orange), #e68900);
            color: white;
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #e68900, #cc5500);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(255, 114, 0, 0.3);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
            border: none;
        }
        .btn-secondary:hover {
            background: linear-gradient(135deg, #5a6268, #495057);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(108, 117, 125, 0.3);
        }
        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            border: none;
        }
        .btn-warning:hover {
            background: linear-gradient(135deg, #e67e22, #d68910);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(243, 156, 18, 0.3);
        }
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
        }
        .btn-danger:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(231, 76, 60, 0.3);
        }
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            border: none;
        }
        .btn-success:hover {
            background: linear-gradient(135deg, #229954, #1e8449);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(39, 174, 96, 0.3);
        }
        .options-section {
            background: #fff8dc;
            border: 2px solid #f39c12;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }
        .options-section h4 {
            color: #d35400;
            margin-bottom: 15px;
            margin-top: 0;
            font-size: 1.2em;
        }
        .checkbox-group {
            display: flex;
            gap: 30px;
            margin-bottom: 15px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .checkbox-item input[type="checkbox"] {
            transform: scale(1.2);
        }
        .checkbox-item label {
            font-weight: 500;
            margin: 0;
        }
        .help-text {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
        .result-section {
            margin-top: 30px;
            padding: 20px;
            border-radius: 10px;
        }
        .result-success {
            background: #d5f4e6;
            border: 2px solid #27ae60;
            color: #155724;
        }
        .result-warning {
            background: #fff3cd;
            border: 2px solid #f39c12;
            color: #856404;
        }
        .result-error {
            background: #f8d7da;
            border: 2px solid #e74c3c;
            color: #721c24;
        }
        .result-info {
            background: #e8f4fd;
            border: 2px solid #3498db;
            color: #1c4e6b;
        }
        .confirmation-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            z-index: 1000;
        }
        .confirmation-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .confirmation-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }
        .confirmation-header .icon {
            font-size: 2em;
        }
        .confirmation-header h3 {
            margin: 0;
            color: #2c3e50;
        }
        .port-status-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .port-status-table th,
        .port-status-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .port-status-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .status-up {
            color: #27ae60;
            font-weight: bold;
        }
        .status-down {
            color: #7f8c8d;
        }
        .mode-access {
            color: #27ae60;
        }
        .mode-trunk, .mode-general {
            color: #f39c12;
            font-weight: bold;
        }
        .uplink-warning {
            color: #e74c3c;
            font-weight: bold;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: white;
            font-weight: 600;
        }
        .loading .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #3498db;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }
        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-top: 5px;
        }
        /* Header and Navigation Styles */
        .header-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 20px 30px;
            margin-bottom: 30px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(103, 126, 234, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid rgba(103, 126, 234, 0.3);
        }
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--orange), #e68900);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        .user-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .username {
            font-weight: 600;
            color: var(--deep-navy);
            font-size: 14px;
        }
        .user-role {
            font-size: 11px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .logout-btn {
            color: #dc2626;
            text-decoration: none;
            font-size: 12px;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        .logout-btn:hover {
            background: rgba(220, 38, 38, 0.1);
        }
        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .logo-section img {
            height: 40px;
        }
        .app-title {
            color: var(--deep-navy);
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }
        /* Navigation styles moved to global navigation.css file */
    </style>
</head>
<body>
    <div class="container">
        <div class="header-card">
            <div class="logo-section">
                <img src="{{ url_for('static', filename='img/kmc_logo.png') }}" alt="KMC Logo">
                <h1 class="app-title">Switch Port Tracer</h1>
            </div>
            <div class="user-profile">
                <div class="user-avatar">{{ username[0].upper() }}</div>
                <div class="user-details">
                    <div class="username">{{ username }}</div>
                    <div class="user-role">{{ user_role }}</div>
                </div>
                <a href="/logout" class="logout-btn">Logout</a>
            </div>
        </div>
        
        <div class="navigation-card">
            <div class="nav-links">
                <a href="/" class="nav-link">🔍 Port Tracer</a>
                {% if user_role in ['netadmin', 'superadmin'] %}
                <a href="/vlan" class="nav-link active">🔧 VLAN Manager</a>
                <a href="/inventory" class="nav-link">🏢 Switch Management</a>
                {% endif %}
            </div>
        </div>

        <!-- Main VLAN Change Form -->
        <div class="form-section">
            <h3>📋 Port VLAN Assignment</h3>
            <form id="vlanChangeForm" class="vlan-form">
                <!-- Switch Selection -->
                <div class="form-row">
                    <div class="form-group compact">
                        <label for="switch_select">🖥️ Target Switch *</label>
                        <select id="switch_select" name="switch_id" required>
                            <option value="">Select a switch...</option>
                        </select>
                        <div class="help-text">Choose the switch where you want to change port VLANs</div>
                    </div>
                </div>

                <!-- Switch Model Display -->
                <div class="form-row" id="switch_model_row" style="display: none;">
                    <div class="form-group small">
                        <label for="switch_model_display">📡 Switch Model</label>
                        <input type="text" id="switch_model_display" readonly 
                               style="background-color: #f8f9fa; cursor: not-allowed;">
                        <div class="help-text">Detected switch model (affects port naming and uplink detection)</div>
                    </div>
                </div>

                <!-- Ports Input -->
                <div class="form-row" style="align-items: flex-start;">
                    <div class="form-group" style="flex: 3;">
                        <label for="ports_input">🔔 Ports *</label>
                        <input type="text" id="ports_input" name="ports" required 
                               placeholder="e.g., gi1/0/1-gi1/0/5, gi2/0/10, gi3/0/15-gi3/0/20">
                        <div class="help-text">
                            <strong>STRICT FORMAT:</strong> gix/x/x-gx/x/x where x=stack/port numbers.<br>
                            Use full interface names only. Separate multiple entries with commas. Uplink ports are protected.
                        </div>
                    </div>
                    <div style="flex: 0; display: flex; flex-direction: column; min-width: 130px;">
                        <div style="height: 31px;"></div>
                        <button type="button" id="checkPortsBtn" class="btn btn-secondary" style="width: 130px; height: 40px; padding: 8px 10px; font-size: 13px; white-space: nowrap;">
                            🔍 Check Ports
                        </button>
                    </div>
                </div>

                <!-- Port Description -->
                <div class="form-row">
                    <div class="form-group medium">
                        <label for="description_input">📝 Port Description *</label>
                        <input type="text" id="description_input" name="description" required
                               placeholder="e.g., Client Name, Room Location">
                        <div class="help-text">Description to set on the interfaces (required)</div>
                    </div>
                </div>

                <!-- VLAN Configuration -->
                <div style="display: flex; align-items: flex-start; gap: 24px; margin-bottom: 20px;">
                    <div style="flex: 0 0 110px;">
                        <label for="vlan_id_input" style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">🏷️ VLAN ID *</label>
                        <input type="number" id="vlan_id_input" name="vlan_id" required min="1" max="4094" 
                               placeholder="100" title="Enter VLAN ID between 1-4094" maxlength="4" 
                               style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;"
                               oninput="this.value=this.value.slice(0,4); if(parseInt(this.value)>4094) this.value=4094;">
                        <div class="help-text">1-4094 only</div>
                    </div>
                    <div style="flex: 1; max-width: 400px; margin-right: 8px;">
                        <label for="vlan_name_input" style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">🏷️ VLAN Name *</label>
                        <input type="text" id="vlan_name_input" name="vlan_name" required 
                               placeholder="e.g., Zone_Client_Name, Internal_Network"
                               style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                        <div class="help-text">VLAN name (creates/updates if needed)<br>
                            <small><strong>Naming Standards:</strong> Zone_Client_Name, Internal_Network, Guest_Access, IoT_Devices</small></div>
                    </div>
                    <div style="flex: 0 0 120px; margin-top: 31px; margin-left: -12px;">
                        <button type="button" id="checkVlanBtn" class="btn btn-secondary" style="width: 120px; height: 42px; padding: 8px 10px; font-size: 12px; white-space: nowrap; position: relative; z-index: 10;">
                            🔍 Check VLAN
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Advanced Options -->
        <div class="options-section">
            <h4>⚙️ Advanced Safety Options</h4>
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="force_change" name="force_change">
                    <label for="force_change">🚨 Force Change All Ports</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="skip_non_access" name="skip_non_access">
                    <label for="skip_non_access">⏭️ Auto-skip Active or Non-Access Ports</label>
                </div>
            </div>
            <div class="help-text">
                <strong>Force Change:</strong> Will change all ports (except uplinks) regardless of status - requires confirmation.<br>
                <strong>Auto-skip Active or Non-Access:</strong> Will automatically skip ports that are UP or not in ACCESS mode.
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="btn-group">
            <button type="button" id="executeBtn" class="btn btn-primary">
                ⚡ Execute VLAN Change
            </button>
            <button type="button" id="clearBtn" class="btn btn-secondary">
                🗑️ Clear Form
            </button>
            <button type="button" id="previewBtn" class="btn btn-warning">
                👁️ Preview Changes
            </button>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loading">
            <div class="spinner"></div>
            <p>Processing VLAN changes, please wait...</p>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="result-section" style="display: none;"></div>

    </div>

    <!-- Confirmation Dialog -->
    <div id="confirmationDialog" class="confirmation-dialog">
        <div class="confirmation-content">
            <div class="confirmation-header">
                <span class="icon">⚠️</span>
                <h3 id="confirmationTitle">Confirmation Required</h3>
            </div>
            <div id="confirmationMessage"></div>
            <div class="btn-group">
                <button id="confirmYes" class="btn btn-danger">✅ Yes, Proceed</button>
                <button id="confirmNo" class="btn btn-secondary">❌ Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script>
        let currentWorkflowData = null;
        
        $(document).ready(function() {
            initializePage();
        });
        
        function initializePage() {
            // Initialize Select2 for switch selection
            $('#switch_select').select2({
                placeholder: 'Search and select a switch...',
                width: '350px',
                dropdownAutoWidth: true
            });
            
            // Load switches
            loadSwitches();
            
            // Bind events
            bindEvents();
        }
        
        function bindEvents() {
            $('#executeBtn').on('click', executeVlanChange);
            $('#clearBtn').on('click', clearForm);
            $('#previewBtn').on('click', previewChanges);
            $('#checkPortsBtn').on('click', checkPortStatus);
            $('#checkVlanBtn').on('click', checkVlanStatus);
            $('#confirmYes').on('click', confirmAction);
            $('#confirmNo').on('click', closeConfirmation);
            
            // Close confirmation dialog on backdrop click
            $('#confirmationDialog').on('click', function(e) {
                if (e.target === this) {
                    closeConfirmation();
                }
            });
        }
        
        function loadSwitches() {
            $.get('/api/switches/list')
                .done(function(data) {
                    const switchSelect = $('#switch_select');
                    switchSelect.empty().append('<option value="">Select a switch...</option>');
                    
                    data.forEach(function(switchData) {
                        switchSelect.append(
                            `<option value="${switchData.id}" 
                                    data-model="${switchData.model}" 
                                    data-ip="${switchData.ip_address}"
                                    data-site="${switchData.site_name}"
                                    data-floor="${switchData.floor_name}">
                                ${switchData.name} - ${switchData.ip_address}
                            </option>`
                        );
                    });
                    
                    // Add change handler for switch selection
                    $('#switch_select').on('change', function() {
                        const selectedOption = $(this).find('option:selected');
                        const switchId = selectedOption.val();
                        const switchModel = selectedOption.attr('data-model');
                        
                        console.log('Switch changed - ID:', switchId, 'Model:', switchModel, 'Option:', selectedOption);
                        
                        if (switchId && switchModel) {
                            console.log('Setting model display to:', switchModel);
                            $('#switch_model_display').val(switchModel);
                            $('#switch_model_row').show();
                            updatePortPlaceholder(switchModel);
                        } else {
                            console.log('Hiding model display');
                            $('#switch_model_display').val('');
                            $('#switch_model_row').hide();
                            resetPortPlaceholder();
                        }
                    });
                    
                    // Trigger change event if there's a pre-selected value
                    $('#switch_select').trigger('change');
                })
                .fail(function() {
                    showResult('error', 'Failed to load switches. Please refresh the page.');
                });
        }
        
        function updatePortPlaceholder(switchModel) {
            const portsInput = $('#ports_input');
            let placeholder = '';
            let helpText = '';
            
            console.log('Updating placeholder for model:', switchModel);
            
            if (switchModel.includes('N2048') || switchModel.includes('N2000')) {
                placeholder = 'e.g., gi1/0/1-gi1/0/5, gi2/0/10, gi3/0/15-gi3/0/20';
                helpText = '<strong>STRICT FORMAT:</strong> gix/x/x-gx/x/x where x=stack/port numbers. <br>Gi ports only (GigabitEthernet access ports). Te ports are uplinks and protected.';
            } else if (switchModel.includes('N3200') || switchModel.includes('N3248') || switchModel.includes('N32')) {
                placeholder = 'e.g., te1/0/1-te1/0/5, te2/0/10, te3/0/15-te3/0/20';
                helpText = '<strong>STRICT FORMAT:</strong> tex/x/x-tex/x/x where x=stack/port numbers. <br>Te ports only (TenGigabitEthernet access ports). Tw ports are uplinks and protected.';
            } else if (switchModel.includes('N30') || switchModel.includes('N3000')) {
                placeholder = 'e.g., gi1/0/1-gi1/0/5, gi2/0/10, gi3/0/15-gi3/0/20';
                helpText = '<strong>STRICT FORMAT:</strong> gix/x/x-gx/x/x where x=stack/port numbers. <br>Gi ports only (GigabitEthernet access ports). Te ports are uplinks and protected.';
            } else {
                placeholder = 'e.g., gi1/0/1-gi1/0/5, gi2/0/10, gi3/0/15-gi3/0/20';
                helpText = '<strong>STRICT FORMAT:</strong> gix/x/x-gx/x/x where x=stack/port numbers. <br>Gi ports only (GigabitEthernet access ports). Te ports are uplinks and protected.';
            }
            
            console.log('Setting placeholder:', placeholder);
            console.log('Setting help text:', helpText);
            
            portsInput.attr('placeholder', placeholder);
            portsInput.siblings('.help-text').html(helpText + '<br><strong>Important:</strong> Separate multiple entries with commas. All ports must use exact interface names.');
        }
        
        function resetPortPlaceholder() {
            $('#ports_input').attr('placeholder', 'e.g., gi1/0/1-gi1/0/5, gi2/0/10, gi3/0/15-gi3/0/20');
            $('#ports_input').siblings('.help-text').html('<strong>STRICT FORMAT:</strong> gix/x/x-gx/x/x where x=stack/port numbers. Select switch to see specific interface requirements.<br><strong>Important:</strong> Use full interface names only. Separate multiple entries with commas.');
        }
        
        function executeVlanChange() {
            if (!validateForm()) return;
            
            const formData = getFormData();
            showLoading(true, 'Processing VLAN changes, please wait...');
            
            $.ajax({
                url: '/api/vlan/change',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(result) {
                    showLoading(false);
                    handleWorkflowResult(result);
                },
                error: function(xhr) {
                    showLoading(false);
                    const error = xhr.responseJSON?.error || 'Unknown error occurred';
                    showResult('error', `Error: ${error}`);
                }
            });
        }
        
        function previewChanges() {
            if (!validateForm()) return;
            
            const formData = getFormData();
            formData.preview_only = true; // This will be a dry run
            
            showLoading(true, 'Previewing changes, please wait...');
            
            // Use the full VLAN change workflow in preview mode
            $.ajax({
                url: '/api/vlan/change',
                method: 'POST', 
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(result) {
                    showLoading(false);
                    showChangePreview(result, formData);
                },
                error: function(xhr) {
                    showLoading(false);
                    const error = xhr.responseJSON?.error || 'Failed to preview changes';
                    showResult('error', `Preview Error: ${error}`);
                }
            });
        }
        
        function checkPortStatus() {
            const switchId = $('#switch_select').val();
            const ports = $('#ports_input').val().trim();
            
            if (!switchId || !ports) {
                showResult('warning', 'Please select a switch and enter ports to check.');
                return;
            }
            
            showLoading(true, 'Checking port status, please wait...');
            
            $.ajax({
                url: '/api/port/status',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    switch_id: switchId,
                    ports: ports
                }),
                success: function(result) {
                    showLoading(false);
                    showPortStatusResult(result);
                },
                error: function(xhr) {
                    showLoading(false);
                    const error = xhr.responseJSON?.error || 'Failed to check port status';
                    showResult('error', `Port Check Error: ${error}`);
                }
            });
        }
        
        function checkVlanStatus() {
            const switchId = $('#switch_select').val();
            const vlanId = $('#vlan_id_input').val();
            const checkBtn = $('#checkVlanBtn');
            
            if (!switchId || !vlanId) {
                showResult('warning', 'Please select a switch and enter a VLAN ID to check.');
                return;
            }
            
            // Show checking status
            checkBtn.prop('disabled', true);
            checkBtn.html('🔄 Checking...');
            showResult('info', 'Checking VLAN existence on switch...');
            
            $.ajax({
                url: '/api/vlan/check',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    switch_id: switchId,
                    vlan_id: vlanId
                }),
                success: function(result) {
                    const status = result.exists ? 'exists' : 'will be created';
                    const name = result.exists ? result.name : 'N/A';
                    showResult('success', 
                        `VLAN ${vlanId} ${status} on selected switch.<br>
                         Current name: <strong>${name}</strong>`);
                },
                error: function(xhr) {
                    const error = xhr.responseJSON?.error || 'Failed to check VLAN';
                    showResult('error', `VLAN Check Error: ${error}`);
                },
                complete: function() {
                    // Reset button state
                    checkBtn.prop('disabled', false);
                    checkBtn.html('🔍 Check VLAN');
                }
            });
        }
        
        function handleWorkflowResult(result) {
            currentWorkflowData = result;
            
            if (result.status === 'confirmation_needed') {
                showConfirmationDialog(result);
            } else if (result.status === 'success') {
                showSuccessResult(result);
            } else if (result.status === 'error') {
                showResult('error', result.error || 'Unknown error occurred');
            }
        }
        
        function showConfirmationDialog(result) {
            let title, message;
            
            if (result.type === 'uplink_protection') {
                title = '🚨 Uplink Port Protection';
                message = `
                    <p><strong>Warning:</strong> ${result.message}</p>
                    <p>${result.details}</p>
                    <p><strong>Uplink ports detected:</strong> ${result.uplink_ports.join(', ')}</p>
                    <p><strong>Safe ports to change:</strong> ${result.safe_ports.length > 0 ? result.safe_ports.join(', ') : 'None'}</p>
                    <p>Do you want to proceed with only the safe ports?</p>
                `;
            } else if (result.type === 'active_or_non_access_ports') {
                title = '⚠️ Active or Non-Access Mode Ports Detected';
                message = `
                    <p><strong>${result.message}</strong></p>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table class="port-status-table">
                            <thead>
                                <tr>
                                    <th>Port</th>
                                    <th>Status</th>
                                    <th>Mode</th>
                                    <th>Current VLAN</th>
                                    <th>Issue</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                result.active_or_non_access_ports.forEach(function(portInfo) {
                    const status = portInfo.current_status;
                    message += `
                        <tr>
                            <td>${status.port}</td>
                            <td class="status-${status.status}">${status.status.toUpperCase()}</td>
                            <td class="mode-${status.mode}">${status.mode.toUpperCase()}</td>
                            <td>${status.current_vlan}</td>
                            <td>${portInfo.reason}</td>
                        </tr>
                    `;
                });
                
                message += `
                            </tbody>
                        </table>
                    </div>
                    <p><strong>Safe ports:</strong> ${result.safe_ports.length > 0 ? result.safe_ports.join(', ') : 'None'}</p>
                    <p>Do you want to proceed anyway? This will change all ports including the active or non-access mode ones.</p>
                `;
            }
            
            $('#confirmationTitle').text(title);
            $('#confirmationMessage').html(message);
            $('#confirmationDialog').show();
        }
        
        function confirmAction() {
            closeConfirmation();
            
            if (currentWorkflowData && currentWorkflowData.status === 'confirmation_needed') {
                // Re-execute with force or skip flags based on the confirmation type
                const formData = getFormData();
                
                if (currentWorkflowData.type === 'uplink_protection') {
                    // Proceed with safe ports only (don't set force_change)
                    formData.force_change = false;
                } else if (currentWorkflowData.type === 'active_or_non_access_ports') {
                    // Force change all ports
                    formData.force_change = true;
                }
                
                showLoading(true, 'Processing VLAN changes, please wait...');
                
                $.ajax({
                    url: '/api/vlan/change',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function(result) {
                        showLoading(false);
                        handleWorkflowResult(result);
                    },
                    error: function(xhr) {
                        showLoading(false);
                        const error = xhr.responseJSON?.error || 'Unknown error occurred';
                        showResult('error', `Error: ${error}`);
                    }
                });
            }
        }
        
        function closeConfirmation() {
            $('#confirmationDialog').hide();
            currentWorkflowData = null;
        }
        
        function showSuccessResult(result) {
            let html = `
                <h3>✅ VLAN Change Completed Successfully</h3>
                <div class="summary-stats">
                    <div class="stat-item">
                        <div class="stat-number">${result.summary.changed}</div>
                        <div class="stat-label">Ports Changed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${result.summary.failed}</div>
                        <div class="stat-label">Failed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${result.summary.skipped}</div>
                        <div class="stat-label">Skipped</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${result.summary.uplink_protected}</div>
                        <div class="stat-label">Uplink Protected</div>
                    </div>
                </div>
                
                <p><strong>Switch:</strong> ${result.switch_info.name} (${result.switch_info.site_name} - ${result.switch_info.floor_name})</p>
                <p><strong>VLAN:</strong> ${result.vlan_id} - ${result.vlan_name}</p>
            `;
            
            if (result.vlan_operation_result) {
                html += `<p><strong>VLAN Operation:</strong> ${result.vlan_operation_result}</p>`;
            }
            
            if (result.ports_changed.length > 0) {
                html += `<p><strong>Ports Successfully Changed:</strong> ${result.ports_changed.join(', ')}</p>`;
            }
            
            if (result.ports_failed.length > 0) {
                html += `<p><strong>Ports Failed:</strong> ${result.ports_failed.join(', ')}</p>`;
            }
            
            if (result.ports_skipped.length > 0) {
                html += `<p><strong>Ports Skipped:</strong> ${result.ports_skipped.join(', ')}</p>`;
            }
            
            showResult('success', html);
        }
        
        function showPortPreview(result) {
            let html = `
                <h3>🔍 Port Status Check - ${result.switch_model} Switch</h3>
                <table class="port-status-table">
                    <thead>
                        <tr>
                            <th>Port</th>
                            <th>Status</th>
                            <th>Mode</th>
                            <th>Current VLAN</th>
                            <th>Uplink</th>
                            <th>Safety</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            result.ports.forEach(function(port) {
                const cautionClass = port.is_uplink ? 'uplink-warning' : 
                                   (port.status === 'up' && port.mode !== 'access') ? 'mode-trunk' : '';
                const caution = port.is_uplink ? '🚨 Uplink' : 
                               (port.status === 'up' && port.mode !== 'access') ? '⚠️ Active/Non-Access' : '✅ Safe';
                
                html += `
                    <tr class="${cautionClass}">
                        <td>${port.port}</td>
                        <td class="status-${port.status}">${port.status.toUpperCase()}</td>
                        <td class="mode-${port.mode}">${port.mode.toUpperCase()}</td>
                        <td>${port.current_vlan}</td>
                        <td>${port.is_uplink ? '🚨 Yes' : '✅ No'}</td>
                        <td>${caution}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                <p class="help-text">
                    🚨 <strong>Uplink ports</strong> are protected and will not be changed.<br>
                    ⚠️ <strong>Active or Non-Access ports</strong> are UP or not in ACCESS mode - require confirmation.<br>
                    ✅ <strong>Safe ports</strong> are DOWN and in ACCESS mode - can be changed safely.
                </p>
            `;
            
            showResult('warning', html);
        }
        
        function showChangePreview(result, formData) {
            if (result.status === 'success') {
                // This is a dry-run success - show what would be changed
                let html = `
                    <h3>👁️ Preview: VLAN Changes - ${result.switch_info.name}</h3>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <div class="stat-number">${result.summary.changed}</div>
                            <div class="stat-label">Ports to Change</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${result.summary.skipped}</div>
                            <div class="stat-label">Would Skip</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${result.summary.uplink_protected}</div>
                            <div class="stat-label">Uplink Protected</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${result.summary.failed}</div>
                            <div class="stat-label">Failed/Issues</div>
                        </div>
                    </div>
                    
                    <div style="background: #e8f4fd; border: 2px solid #3498db; border-radius: 8px; padding: 15px; margin: 15px 0;">
                        <h4 style="color: #2c3e50; margin: 0 0 10px 0;">📋 Planned Changes</h4>
                        <p><strong>Target VLAN:</strong> ${formData.vlan_id} - ${formData.vlan_name}</p>
                        <p><strong>Port Description:</strong> ${formData.description}</p>
                        <p><strong>Switch:</strong> ${result.switch_info.name} (${result.switch_info.site_name} - ${result.switch_info.floor_name})</p>
                `;
                
                if (result.vlan_operation_result) {
                    html += `<p><strong>VLAN Operation:</strong> ${result.vlan_operation_result}</p>`;
                }
                
                html += `</div>`;
                
                if (result.ports_changed.length > 0) {
                    html += `
                        <div style="background: #d5f4e6; border: 2px solid #27ae60; border-radius: 8px; padding: 15px; margin: 10px 0;">
                            <h4 style="color: #155724; margin: 0 0 10px 0;">✅ Ports Ready to Change</h4>
                            <p><strong>These ports will be changed:</strong> ${result.ports_changed.join(', ')}</p>
                        </div>
                    `;
                }
                
                if (result.ports_skipped.length > 0) {
                    html += `
                        <div style="background: #fff3cd; border: 2px solid #f39c12; border-radius: 8px; padding: 15px; margin: 10px 0;">
                            <h4 style="color: #856404; margin: 0 0 10px 0;">⏭️ Ports Would Be Skipped</h4>
                            <p><strong>These ports would be skipped:</strong> ${result.ports_skipped.join(', ')}</p>
                            <p class="help-text">Reasons: Uplink protection, active or non-access mode status, or user settings</p>
                        </div>
                    `;
                }
                
                if (result.ports_failed.length > 0) {
                    html += `
                        <div style="background: #f8d7da; border: 2px solid #e74c3c; border-radius: 8px; padding: 15px; margin: 10px 0;">
                            <h4 style="color: #721c24; margin: 0 0 10px 0;">❌ Issues Detected</h4>
                            <p><strong>These ports have issues:</strong> ${result.ports_failed.join(', ')}</p>
                            <p class="help-text">These ports may require attention or manual intervention</p>
                        </div>
                    `;
                }
                
                html += `
                    <div style="background: #f8f9fa; border: 2px solid #6c757d; border-radius: 8px; padding: 15px; margin: 15px 0;">
                        <h4 style="color: #495057; margin: 0 0 10px 0;">ℹ️ Preview Summary</h4>
                        <p>This is a <strong>preview only</strong> - no actual changes have been made to the switch.</p>
                        <p>Use the "Execute VLAN Change" button to apply these changes for real.</p>
                        <p>If you see any issues above, review your port selections and settings before executing.</p>
                    </div>
                `;
                
                showResult('success', html);
            } else if (result.status === 'confirmation_needed') {
                // Show the preview with the confirmation details
                showConfirmationDialog(result);
            } else if (result.status === 'error') {
                showResult('error', `Preview failed: ${result.error || 'Unknown error occurred'}`);
            } else {
                // Fallback - treat as basic port status
                if (result.ports) {
                    showPortPreview(result);
                } else {
                    showResult('error', 'Unexpected preview result format');
                }
            }
        }
        
        function showPortStatusResult(result) {
            showPortPreview(result);
        }
        
        function validateForm() {
            const switchId = $('#switch_select').val();
            const ports = $('#ports_input').val().trim();
            const description = $('#description_input').val().trim();
            const vlanIdInput = $('#vlan_id_input').val();
            const vlanId = parseInt(vlanIdInput);
            const vlanName = $('#vlan_name_input').val().trim();
            
            if (!switchId) {
                showResult('warning', 'Please select a switch.');
                return false;
            }
            
            if (!ports) {
                showResult('warning', 'Please enter ports to configure.');
                return false;
            }
            
            if (!description) {
                showResult('warning', 'Please enter a port description.');
                $('#description_input').focus();
                return false;
            }
            
            // Enhanced VLAN ID validation
            if (!vlanIdInput || vlanIdInput.trim() === '') {
                showResult('warning', 'Please enter a VLAN ID.');
                $('#vlan_id_input').focus();
                return false;
            }
            
            if (isNaN(vlanId) || vlanId < 1 || vlanId > 4094) {
                showResult('warning', 'VLAN ID must be between 1 and 4094.');
                $('#vlan_id_input').focus().select();
                return false;
            }
            
            if (vlanIdInput.length > 4 || vlanId > 4094) {
                showResult('warning', 'VLAN ID cannot exceed 4094.');
                $('#vlan_id_input').val(4094).focus().select();
                return false;
            }
            
            if (!vlanName) {
                showResult('warning', 'Please enter a VLAN name.');
                return false;
            }
            
            return true;
        }
        
        function getFormData() {
            return {
                switch_id: parseInt($('#switch_select').val()),
                ports: $('#ports_input').val().trim(),
                description: $('#description_input').val().trim(),
                vlan_id: parseInt($('#vlan_id_input').val()),
                vlan_name: $('#vlan_name_input').val().trim(),
                force_change: $('#force_change').is(':checked'),
                skip_non_access: $('#skip_non_access').is(':checked')
            };
        }
        
        function clearForm() {
            $('#vlanChangeForm')[0].reset();
            $('#switch_select').val(null).trigger('change');
            $('#force_change, #skip_non_access').prop('checked', false);
            hideResults();
        }
        
        function showLoading(show, message) {
            if (show) {
                // Update loading message if provided
                if (message) {
                    $('#loadingIndicator p').text(message);
                }
                $('#loadingIndicator').show();
                $('#executeBtn, #previewBtn').prop('disabled', true);
            } else {
                $('#loadingIndicator').hide();
                $('#executeBtn, #previewBtn').prop('disabled', false);
                // Reset to default message
                $('#loadingIndicator p').text('Processing VLAN changes, please wait...');
            }
        }
        
        function showResult(type, message) {
            const resultsSection = $('#resultsSection');
            resultsSection.removeClass('result-success result-warning result-error');
            resultsSection.addClass('result-' + type);
            resultsSection.html(message);
            resultsSection.show();
            
            // Scroll to results
            resultsSection[0].scrollIntoView({ behavior: 'smooth' });
        }
        
        function hideResults() {
            $('#resultsSection').hide();
        }
    </script>
</body>
</html>
